generator client {
  provider      = "prisma-client-js"
  output        = "./generated/client"
  // native: 로컬 개발 환경 (macOS, Windows, Linux)
  // Dockerfile: node:20-slim은 glibc+OpenSSL 3.0이므로 linux-x64-openssl-3.0.x, linux-arm64-openssl-3.0.x 조합 (따라서 현재, 도커 빌드시 멀티아키로 빌드하고 있음)
  // GitHub Actions Ubuntu 환경을 위한 debian-openssl-3.0.x 추가
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 아래 모델 정의는 기존 백엔드의 스키마를 공용 패키지로 이동한 것입니다.
// User model for authentication and user management
model User {
  id               String   @id @default(cuid())              // 고유 식별자 (UUID)
  phone            String   @unique                           // 휴대폰 번호 (통합 정보 탐색용, 필수)
  passwordHash     String?  @map("password_hash")             // 암호화된 비밀번호 (일반 회원가입용)
  name             String?                                    // 사용자 실명
  nickname         String?                                    // 닉네임
  email            String?                                    // 이메일
  profileImageUrl  String?  @map("profile_image_url")         // 프로필 이미지 URL
  isPhoneVerified  Boolean  @default(false) @map("is_phone_verified") // 휴대폰 인증 여부
  isActive         Boolean  @default(true) @map("is_active")  // 계정 활성화 상태
  role             UserRole @default(USER)                    // 사용자 권한 (USER, SELLER, ADMIN)
  // 일반 회원가입 관련 필드
  userId           String?  @unique @map("user_id")           // 사용자 ID (일반 회원가입용, 소셜 로그인 시 null 가능)
  // 소셜 로그인 관련 필드
  googleId         String?  @unique @map("google_id")         // 구글 사용자 ID
  googleEmail      String?  @map("google_email")              // 구글 이메일
  // 계정 생성/수정 정보
  createdAt        DateTime @default(now()) @map("created_at")  // 계정 생성일시
  lastLoginAt      DateTime? @map("last_login_at")            // 마지막 로그인 시간

  // Stateless JWT 방식으로 변경하여 RefreshToken 관계 제거

  // Relations
  productLikes   ProductLike[]
  stores        Store[]
  carts         Cart[]

  @@index([phone])
  @@index([userId])
  @@index([googleId])
  @@map("users")
}

// Phone verification for registration and password recovery
model PhoneVerification {
  id               String   @id @default(cuid())
  phone            String
  verificationCode String   @map("verification_code")
  expiresAt        DateTime @map("expires_at")
  isVerified       Boolean  @default(false) @map("is_verified")
  purpose          String   @default("registration")
  userId           String?  @map("user_id")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  @@unique([phone, verificationCode])
  @@map("phone_verifications")
}

// Product model for product management
model Product {
  id                String   @id @default(cuid())
  
  // 판매자 정보
  storeId           String   @map("store_id") // 스토어 ID
  
  // 상품 정보
  name              String
  description       String?
  originalPrice     Int
  salePrice         Int
  stock             Int      // 재고 수량
  notice            String?
  caution           String?
  basicIncluded     String?  @map("basic_included")
  location          String?
  likeCount         Int      @default(0) @map("like_count")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  orderFormSchema   Json?     @map("order_form_schema")

  // 상세 정보
  detailDescription String?  @map("detail_description")

  // 취소 및 환불
  cancellationRefundDetailDescription String?  @map("cancellation_refund_detail_description")

  // 고시정보 (식품 판매 시 법적 필수 항목)
  productNumber     String   @map("product_number")  // 상품번호 (백엔드 자동 생성)
  productNoticeFoodType          String  @map("product_notice_food_type")        // 식품의 유형 (필수)
  productNoticeProducer          String  @map("product_notice_producer")         // 제조사 (필수)
  productNoticeOrigin            String  @map("product_notice_origin")           // 원산지 (필수)
  productNoticeAddress           String  @map("product_notice_address")          // 소재지 (필수)
  productNoticeManufactureDate   String  @map("product_notice_manufacture_date") // 제조연월일 (필수)
  productNoticeExpirationDate    String  @map("product_notice_expiration_date")  // 소비기한 또는 품질유지기한 (필수)
  productNoticePackageCapacity   String  @map("product_notice_package_capacity") // 포장단위별 용량/수량 (필수)
  productNoticePackageQuantity   String  @map("product_notice_package_quantity") // 포장 단위별 수량 (필수)
  productNoticeIngredients       String  @map("product_notice_ingredients")      // 원재료명 및 함량 (필수)
  productNoticeCalories          String  @map("product_notice_calories")         // 영양성분 (필수)
  productNoticeSafetyNotice      String  @map("product_notice_safety_notice")    // 소비자안전을 위한 주의사항 (필수)
  productNoticeGmoNotice         String  @map("product_notice_gmo_notice")       // 유전자변형식품에 해당하는 경우의 표시 (필수)
  productNoticeImportNotice      String  @map("product_notice_import_notice")    // 수입식품의 경우 (필수)
  productNoticeCustomerService   String  @map("product_notice_customer_service") // 고객센터 (필수)

  // 필터 정보
  mainCategory      MainCategory @map("main_category")
  sizeRange         SizeRange[] @map("size_range")
  deliveryMethod    DeliveryMethod[]
  
  // 해시태그
  hashtags          String[]

  // 상품 이미지
  images            String[]

  // 상품 상태
  status            ProductStatus @default(ACTIVE)

  // Relations
  // Seller는 store.seller를 통해 참조 가능
  store             Store          @relation(fields: [storeId], references: [id], onDelete: Cascade)
  likes             ProductLike[]
  carts             Cart[]
  
  @@index([storeId])
  @@index([status])
  @@index([createdAt])
  @@index([salePrice])
  @@index([likeCount])
  @@index([name])
  @@index([hashtags])
  @@index([mainCategory])
  @@index([sizeRange])
  @@index([deliveryMethod])
  @@map("products")
}

// Product like model
model ProductLike {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  productId String   @map("product_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([userId])
  @@index([productId])
  @@map("product_likes")
}

// product.constants.ts 에서 사용하는 enum들
enum MainCategory {
  CAKE    // 케이크
  SUPPLY  // 용품
  OTHER   // 기타
}

enum SizeRange {
  ONE_TO_TWO
  TWO_TO_THREE
  THREE_TO_FOUR
  FOUR_TO_FIVE
  FIVE_OR_MORE
}

enum DeliveryMethod {
  PICKUP
  DELIVERY
}

enum ProductStatus {
  ACTIVE
  INACTIVE
  OUT_OF_STOCK
}

enum UserRole {
  USER
  SELLER
  ADMIN
}

// Store model for seller store information
model Store {
  id                String   @id @default(cuid())
  userId            String   @map("user_id")
  
  // 스토어 정보
  logoImageUrl      String?  @map("logo_image_url")
  name              String
  description       String?
  
  // 사업자 정보 (1단계 - 사용자 입력값만 저장)
  businessNo        String   @map("business_no")
  representativeName String  @map("representative_name")
  openingDate       String   @map("opening_date")
  businessName      String   @map("business_name")
  businessSector    String   @map("business_sector")
  businessType      String   @map("business_type")
  
  // 통신판매사업자 정보 (2단계 - 사용자 입력값만 저장)
  permissionManagementNumber String @map("permission_management_number")
  
  // 주의: 응답 값(businessStatus, taxType, onlineTradingCompanyDetail 등)은 저장하지 않음
  // 필요시 외부 API를 호출하여 최신 상태 조회
  
  // 계정 생성/수정 정보
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  // Relations
  seller            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  products          Product[]
  
  @@unique([userId, businessNo, permissionManagementNumber])
  @@index([userId])
  @@index([businessNo])
  @@map("stores")
}

// Cart model for shopping cart management
model Cart {
  id            String   @id @default(cuid())
  userId        String   @map("user_id")
  productId     String   @map("product_id")
  quantity      Int      @default(1) // 수량
  orderFormData Json?    @map("order_form_data") // 주문 폼 데이터 (JSON)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  product       Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([productId])
  @@map("carts")
}


