# 데이터베이스 관리 가이드

## 환경별 데이터베이스 설정

### 개발 환경 (Development)

- **데이터베이스**: 로컬 PostgreSQL
- **연결 방식**: 직접 연결
- **용도**: 로컬 개발 및 테스트

### 스테이징/프로덕션 환경

- **데이터베이스**: AWS RDS PostgreSQL
- **연결 방식**: 직접 연결 또는 Prisma Accelerate
- **용도**: 배포 전 검증 및 실제 서비스 운영

## PostgreSQL 설치 및 설정

### macOS 설치 (Homebrew)

```bash
# PostgreSQL 설치
brew install postgresql@15

# PostgreSQL 서비스 시작
brew services start postgresql@15

# PostgreSQL에 접속
psql postgres
```

### 데이터베이스 생성

```sql
-- PostgreSQL에 접속한 후 실행
CREATE DATABASE your_database_name;
CREATE USER your_username WITH PASSWORD 'your_secure_password';
GRANT ALL PRIVILEGES ON DATABASE your_database_name TO your_username;
```

### 환경 변수 설정

```bash
# .env.developmen
```

## Prisma와 PostgreSQL 연동

### Prisma 스키마 설정

```prisma
// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 예시 모델
model User {
  id        String   @id @default(cuid())
  name      String?
  email     String?  @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}
```

### 마이그레이션 관리

```bash
# 개발 환경 마이그레이션
yarn db:migrate:dev

# 개발 환경 데이터베이스 리셋
yarn db:reset:dev

# 개발 환경 시드 데이터
yarn db:seed:dev

# Prisma Studio 실행
yarn db:studio:dev

# 스테이징/프로덕션 배포
yarn db:deploy:staging
yarn db:deploy:production
```

### NestJS에서 Prisma 사용

```typescript
// src/database/prisma.service.ts
import { Injectable, OnModuleInit, OnModuleDestroy } from "@nestjs/common";
import { PrismaClient } from "@prisma/client";

@Injectable()
export class PrismaService extends PrismaClient implements OnModuleInit, OnModuleDestroy {
  async onModuleInit(): Promise<void> {
    await this.$connect();
  }

  async onModuleDestroy(): Promise<void> {
    await this.$disconnect();
  }
}
```

## 모범 사례

### 스키마 설계

- **정규화**: 적절한 수준의 정규화 유지
- **인덱스**: 자주 조회되는 컬럼에 인덱스 생성
- **제약조건**: 데이터 무결성을 위한 제약조건 설정
- **네이밍**: 일관된 네이밍 컨벤션 사용 (snake_case for DB, camelCase for Prisma)

### 쿼리 최적화

- **EXPLAIN 사용**: 쿼리 실행 계획 분석
- **인덱스 활용**: 적절한 인덱스 사용
- **N+1 문제 방지**: JOIN 또는 include 사용
- **페이징**: 대용량 데이터 조회 시 LIMIT/OFFSET 사용

## 참고 자료

- [PostgreSQL 공식 문서](https://www.postgresql.org/docs/)
- [Prisma 공식 문서](https://www.prisma.io/docs/)
- [NestJS 공식 문서](https://docs.nestjs.com/)
