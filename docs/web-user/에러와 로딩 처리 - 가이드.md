# 에러와 로딩 처리 - 가이드

## 개요

이 문서는 스위트오더 웹 사용자 앱에서 에러와 로딩을 처리하는 방식에 대해 설명합니다.

## 에러 처리

### 1. ErrorBoundary (UI 에러 처리)

**용도**: React 컴포넌트에서 발생하는 UI 에러를 잡아서 처리

**구현 위치**: `apps/web-user/src/common/components/providers/ErrorBoundaryProvider.tsx`

```typescript
export function ErrorBoundaryProvider({ children }: ErrorBoundaryProviderProps) {
  const handleError = (error: Error, errorInfo: ErrorInfo) => {
    // 에러 로깅 (추후 에러 모니터링 서비스 연동 가능)
    console.error("ErrorBoundary caught an error:", error, errorInfo);
  };

  return (
    <ErrorBoundary
      onError={handleError}
      fallbackRender={({ error, resetErrorBoundary }) => (
        <ErrorFallback error={error} resetErrorBoundary={resetErrorBoundary} />
      )}
    >
      {children}
    </ErrorBoundary>
  );
}
```

**특징**:

- `react-error-boundary` 라이브러리 사용
- 에러 발생 시 `ErrorFallback` 컴포넌트로 대체
- 에러 로깅 기능 포함
- 재시도 기능 제공
- 리액트 쿼리 throwOnError true설정 시, 비동기 에러 발생 시 예외(throw error)를 던지며 상위의 ErrorBoundary 컴포넌트에서 인식됩니다.

### 2. React Query onError (비동기 에러 처리)

**용도**: API 호출에서 발생하는 비동기 에러를 처리

**구현 위치**: `apps/web-user/src/features/auth/hooks/queries/useAuth.ts`

```typescript
export function useLogin() {
  const { showAlert } = useAlertStore();

  return useMutation({
    mutationFn: authApi.login,
    onSuccess: (data) => {
      // 성공 처리
    },
    onError: (error) => {
      showAlert({
        type: "error",
        title: "오류",
        message: getApiMessage.error(error),
      });
    },
  });
}
```

**특징**:

- 대부분의 API 에러는 `onError`에서 Alert으로 표시

### 3. 비즈니스 로직이 있는 경우의 에러 처리

**구현 위치**: `apps/web-user/src/app/auth/login/google/page.tsx`

```typescript
const handleGoogleCallback = async (code: string) => {
  // 특별한 비즈니스 로직(휴대폰 인증 필요)이 있으므로 try-catch 유지
  try {
    await googleLoginMutation.mutateAsync(code);
  } catch (error: any) {
    const { googleId, googleEmail, message } = error?.response?.data?.data || {};

    if (message === "휴대폰 인증이 필요합니다.") {
      setGoogleLoginData({ googleId, googleEmail });
      setShowPhoneVerification(true);
    } else {
      // 다른 오류의 경우 로그인 페이지로 이동
      router.push(PATHS.HOME);
    }
  }
};
```

**특징**:

- 비즈니스 로직이 필요한 경우 컴포넌트 내부에서 `try-catch`로 처리
- `mutateAsync`를 사용하여 에러를 직접 catch
- React Query의 `onError`에서 `throw error`로 에러를 다시 전파

### 5. Axios 인터셉터를 통한 에러 처리

**구현 위치**: `apps/web-user/src/common/config/axios.config.ts`

```typescript
apiClient.interceptors.response.use(
  (response: AxiosResponse) => {
    return response;
  },
  async (error: AxiosError<any>) => {
    const status = error.response?.status;
    const message = error.response?.data?.data?.message;

    // 401 에러 처리 (토큰 갱신)
    if (status === 401 && message?.includes("ACCESS_TOKEN_INVALID")) {
      // 토큰 갱신 로직
    }

    // 그 외 에러는 그대로 전파
    return Promise.reject(error);
  },
);
```

**특징**:

- 401 에러 시 자동 토큰 갱신 시도
- 다른 에러는 그대로 전파
- 자세한 내용은 [통합 인증 - 가이드](../common/통합 인증 - 가이드.md) 참고

## 로딩 처리

### 1. Suspense (UI 로딩 처리)

**용도**: React 컴포넌트의 로딩 상태를 처리

**구현 위치**: `apps/web-user/src/app/layout.tsx`

```typescript
<ErrorBoundaryProvider>
  <QueryProvider>
    <Suspense
      fallback={<LoadingFallback variant="overlay" message="페이지를 불러오는 중" />}
    >
      {children}
    </Suspense>
    <AuthInitializerProvider />
    <Alert />
  </QueryProvider>
</ErrorBoundaryProvider>
```

**특징**:

- 전역 Suspense로 페이지 로딩 처리
- `LoadingFallback` 컴포넌트로 로딩 UI 표시
- `overlay` 방식으로 전체 화면 로딩 표시

### 2. React Query isPending (비동기 로딩 처리)

**용도**: API 호출 중 로딩 상태를 처리

**구현 위치**: 각 폼 컴포넌트들

```typescript
// 로그인 폼 예시
export default function LoginForm() {
  const loginMutation = useLogin();

  return (
    <Button
      type="submit"
      disabled={
        !userId || !password || !!userIdError || !!passwordError || loginMutation.isPending
      }
    >
      {loginMutation.isPending ? "로그인 중..." : "로그인"}
    </Button>
  );
}
```

**특징**:

- 지역 컴포넌트에서 `isPending` 사용
- 버튼 비활성화 및 텍스트 변경
- 낙관적 업데이트를 위한 로딩 UI 제공

### 3. LoadingFallback 컴포넌트

**구현 위치**: `apps/web-user/src/common/components/fallbacks/LoadingFallback.tsx`

**특징**:

- `overlay` 방식: 전체 화면 로딩
- `corner` 방식: 우측 하단 로딩

## 참고사항

1. **useQuerySuspense**: 리액트 쿼리(TanStack Query v5)의 기본 기능으로, 비동기 데이터를 불러오는 동안 로딩 표시를 해줍니다. 상위의 Suspense 컴포넌트에서 인식됩니다.
2. **throwOnError**: 리액트 쿼리(TanStack Query v5)의 기본 기능으로, 비동기 데이터를 불러오는 동안 에러 발생 시 예외(throw error)를 던집니다. 상위의 ErrorBoundary 컴포넌트에서 인식됩니다.
