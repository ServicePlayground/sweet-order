# Sentry ì—ëŸ¬ ë¡œê¹… í†µí•© ì„¤ê³„ ê°€ì´ë“œ

## ğŸ“‹ ê°œìš”

ë³¸ ë¬¸ì„œëŠ” SweetOrder ë°±ì—”ë“œì— êµ¬í˜„ëœ Sentry ì—ëŸ¬ ë¡œê¹… ì‹œìŠ¤í…œì˜ êµ¬ì¡°ì™€ ë™ì‘ ë°©ì‹ì„ ì„¤ëª…í•˜ëŠ” ê°€ì´ë“œì…ë‹ˆë‹¤.

**ìµœì¢… ì—…ë°ì´íŠ¸**: 2025-01-23  
**ëŒ€ìƒ**: `apps/backend` ë””ë ‰í† ë¦¬

---

## 1. ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

### 1.1 ì „ì²´ êµ¬ì¡°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    NestJS Application                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         Global Exception Filter                        â”‚  â”‚
â”‚  â”‚  (ErrorResponseInterceptor)                            â”‚  â”‚
â”‚  â”‚  - ëª¨ë“  ì˜ˆì™¸ ìºì¹˜                                       â”‚  â”‚
â”‚  â”‚  - ë¯¼ê° ì •ë³´ ë§ˆìŠ¤í‚¹ (SensitiveDataUtil)                 â”‚  â”‚
â”‚  â”‚  - ë¡œê¹… (LoggerUtil)                                    â”‚  â”‚
â”‚  â”‚  - Sentry ì „ì†¡ (SentryUtil)                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â”‚                                   â”‚
â”‚                          â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         LoggerUtil (Static Utility)                   â”‚  â”‚
â”‚  â”‚  - ê°œë°œ/ê²€ì¦ í™˜ê²½ì—ì„œë§Œ ë¡œê¹…                            â”‚  â”‚
â”‚  â”‚  - NestJS Logger ë˜í¼                                   â”‚  â”‚
â”‚  â”‚  - ì½˜ì†” ì¶œë ¥                                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â”‚                                   â”‚
â”‚                          â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         SentryUtil (Static Utility)                   â”‚  â”‚
â”‚  â”‚  - ê²€ì¦/ìƒìš© í™˜ê²½ì—ì„œë§Œ ì „ì†¡                            â”‚  â”‚
â”‚  â”‚  - 5xx ì—ëŸ¬ë§Œ ì „ì†¡                                      â”‚  â”‚
â”‚  â”‚  - ì—ëŸ¬ ë ˆë²¨ ê²°ì •                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â”‚                                   â”‚
â”‚                          â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         Sentry SDK (@sentry/nestjs)                    â”‚  â”‚
â”‚  â”‚  - ì´ˆê¸°í™”: sentry.config.ts                             â”‚  â”‚
â”‚  â”‚  - ê²€ì¦/ìƒìš© í™˜ê²½ì—ì„œë§Œ í™œì„±í™”                           â”‚  â”‚
â”‚  â”‚  - Transaction ë¹„í™œì„±í™” (ì—ëŸ¬ë§Œ ì „ì†¡)                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Sentry Cloud          â”‚
        â”‚   (ê²€ì¦/ìƒìš© í™˜ê²½)        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 ë””ë ‰í† ë¦¬ êµ¬ì¡°

```
apps/backend/src/
â”œâ”€â”€ common/
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â””â”€â”€ sentry.config.ts              # Sentry ì´ˆê¸°í™” ì„¤ì •
â”‚   â”œâ”€â”€ interceptors/
â”‚   â”‚   â””â”€â”€ error-response.interceptor.ts # ì „ì—­ ì˜ˆì™¸ í•„í„°
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ logger.util.ts                # ë¡œê¹… ìœ í‹¸ë¦¬í‹°
â”‚       â”œâ”€â”€ sentry.util.ts                 # Sentry ìœ í‹¸ë¦¬í‹°
â”‚       â””â”€â”€ sensitive-data.util.ts         # ë¯¼ê° ì •ë³´ ë§ˆìŠ¤í‚¹
â”œâ”€â”€ main.ts                                # ì• í”Œë¦¬ì¼€ì´ì…˜ ì§„ì…ì 
â””â”€â”€ ...
```

---

## 2. Sentry ì´ˆê¸°í™” ì„¤ì •

**ìœ„ì¹˜**: `apps/backend/src/common/config/sentry.config.ts`

**ì—­í• **: Sentry SDK ì´ˆê¸°í™” ë° í™˜ê²½ë³„ ì„¤ì •

**ì£¼ìš” ì„¤ì •**:
- ê²€ì¦(staging) ë˜ëŠ” ìƒìš©(production) í™˜ê²½ì—ì„œë§Œ ì´ˆê¸°í™”
- `tracesSampleRate: 0`: Transaction ë¹„í™œì„±í™” (ì—ëŸ¬ ì´ë²¤íŠ¸ë§Œ ì „ì†¡í•˜ì—¬ ë¹„ìš© ì ˆê°)
- `sendDefaultPii: false`: ê¸°ë³¸ PII ë°ì´í„° ìˆ˜ì§‘ ë¹„í™œì„±í™” (ê°œì¸ì •ë³´ ë³´í˜¸)
- `environment`: í™˜ê²½ íƒœê·¸ ìë™ ì„¤ì •

## 3. í™˜ê²½ë³„ ë™ì‘ ë°©ì‹

### 3.1 ê°œë°œ í™˜ê²½ (development)

**ë¡œê¹…**:
- âœ… `LoggerUtil.log()`: ì½˜ì†”ì— ë¡œê·¸ ì¶œë ¥
- âœ… `morgan`: HTTP ìš”ì²­ ë¡œê¹… (main.tsì—ì„œ ì„¤ì •)
- âŒ Sentry: ë¹„í™œì„±í™”

**ì—ëŸ¬ í™•ì¸ ë°©ë²•**:
- ë¡œì»¬ ì½˜ì†”ì—ì„œ ì§ì ‘ í™•ì¸
- ê°œë°œ ì„œë²„ ì‹¤í–‰ ì‹œ í„°ë¯¸ë„ì— ëª¨ë“  ë¡œê·¸ ì¶œë ¥

**ì„¤ì •**:
```env
NODE_ENV=development
SENTRY_DSN=  # ë¹„ì–´ìˆê±°ë‚˜ ì„¤ì •í•˜ì§€ ì•ŠìŒ
```

### 3.2 ê²€ì¦ í™˜ê²½ (staging)

**ë¡œê¹…**:
- âœ… `LoggerUtil.log()`: ì½˜ì†”ì— ë¡œê·¸ ì¶œë ¥
- âœ… `morgan`: HTTP ìš”ì²­ ë¡œê¹…
- âœ… Sentry: í™œì„±í™” (5xx ì—ëŸ¬ë§Œ ì „ì†¡)

**ì—ëŸ¬ í™•ì¸ ë°©ë²•**:
- **ë¡œê¹…**: SSHë¡œ ì„œë²„ì— ì§ì ‘ ì ‘ì†í•˜ì—¬ ë¡œê·¸ í™•ì¸
  ```bash
  # ì„œë²„ ì ‘ì† í›„
  docker logs -f <container-name>
  # ë˜ëŠ”
  journalctl -u <service-name> -f
  ```
- **ì—ëŸ¬**: Sentry ëŒ€ì‹œë³´ë“œì—ì„œ í™•ì¸

**ì„¤ì •**:
```env
NODE_ENV=staging
SENTRY_DSN=https://xxx@sentry.io/xxx
```

### 3.3 ìƒìš© í™˜ê²½ (production)

**ë¡œê¹…**:
- âŒ `LoggerUtil.log()`: ë¡œê¹…í•˜ì§€ ì•ŠìŒ (ì„±ëŠ¥ ìµœì í™”)
- âŒ `morgan`: ë¹„í™œì„±í™”
- âœ… Sentry: í™œì„±í™” (5xx ì—ëŸ¬ë§Œ ì „ì†¡)

**ì—ëŸ¬ í™•ì¸ ë°©ë²•**:
- **ë¡œê¹…**: ìš´ì˜ í™˜ê²½ì—ì„œëŠ” ë¡œê¹… ë¹„í™œì„±í™” (ì„±ëŠ¥ ìµœì í™”)
- **ì—ëŸ¬**: Sentry ëŒ€ì‹œë³´ë“œì—ì„œë§Œ í™•ì¸

**ì„¤ì •**:
```env
NODE_ENV=production
SENTRY_DSN=https://xxx@sentry.io/xxx
```

---

## 4. Sentry í”„ë¡œì íŠ¸ ì„¤ì •

### 4.1 í”„ë¡œì íŠ¸ ìƒì„±

1. **í”Œë«í¼**: Nest.js
2. **ì•Œë¦¼**: ì¤‘ìš” ì´ìŠˆ, ì´ë©”ì¼ë¡œ ì•Œë¦¼ (Slack, DiscordëŠ” ìœ ë£Œ í”Œëœ)
3. **í”„ë¡œì íŠ¸ ì´ë¦„**: `sweetorder-backend-staging` (ê²€ì¦ í™˜ê²½)

### 4.2 í™˜ê²½ ë³€ìˆ˜ ì„¤ì •

ê° í™˜ê²½ë³„ `.env` íŒŒì¼ì— ì¶”ê°€:

```env
# .env.development
NODE_ENV=development
SENTRY_DSN=  # ë¹„ì–´ìˆê±°ë‚˜ ì„¤ì •í•˜ì§€ ì•ŠìŒ

# .env.staging
NODE_ENV=staging
SENTRY_DSN=https://xxx@sentry.io/xxx

# .env.production
NODE_ENV=production
SENTRY_DSN=https://xxx@sentry.io/xxx
```

### 4.3 Sentry ì´ˆê¸°í™”

`main.ts`ì—ì„œ ìë™ìœ¼ë¡œ ì´ˆê¸°í™”ë©ë‹ˆë‹¤:

```typescript
// apps/backend/src/main.ts
import { initializeSentry } from "@apps/backend/common/config/sentry.config";
import { SentryUtil } from "@apps/backend/common/utils/sentry.util";

async function bootstrap(): Promise<void> {
  const app = await NestFactory.create(AppModule);
  const configService = app.get(ConfigService);

  // LoggerUtil ì´ˆê¸°í™”
  LoggerUtil.initialize(configService);

  // SentryUtil ì´ˆê¸°í™”
  SentryUtil.initialize(configService);

  // Sentry ì´ˆê¸°í™”
  initializeSentry(configService);

  // ... ë‚˜ë¨¸ì§€ ì„¤ì • ...
}
```

---

## 5. ì—ëŸ¬ ì¶”ì  ë° ë””ë²„ê¹…

### 5.1 Response IDë¥¼ í†µí•œ ì¶”ì 

ëª¨ë“  ì—ëŸ¬ ì‘ë‹µì—ëŠ” `responseId`ê°€ í¬í•¨ë˜ì–´ ìˆìœ¼ë©°, ì´ IDëŠ” Sentryì˜ íƒœê·¸ë¡œë„ ì „ì†¡ë©ë‹ˆë‹¤.

**í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì‚¬ìš©**:
1. ì—ëŸ¬ ì‘ë‹µì—ì„œ `responseId` ì¶”ì¶œ
2. Sentry ëŒ€ì‹œë³´ë“œì—ì„œ `responseId` íƒœê·¸ë¡œ ê²€ìƒ‰
3. í•´ë‹¹ ì—ëŸ¬ì˜ ìƒì„¸ ì •ë³´ í™•ì¸

**ì˜ˆì‹œ**:
```json
{
  "success": false,
  "data": { ... },
  "responseId": "1706004000000-error-uuid-hex",
  "statusCode": 500
}
```

Sentryì—ì„œ íƒœê·¸: `responseId: 1706004000000-error-uuid-hex`

## 6. ë¯¼ê° ì •ë³´ ë³´í˜¸

### 6.1 ìë™ ë§ˆìŠ¤í‚¹

`SensitiveDataUtil`ì„ í†µí•´ ìë™ìœ¼ë¡œ ë¯¼ê° ì •ë³´ê°€ ë§ˆìŠ¤í‚¹ë©ë‹ˆë‹¤:

- ì´ë©”ì¼: `user@example.com` â†’ `u***@example.com`
- ì „í™”ë²ˆí˜¸: `010-1234-5678` â†’ `010-****-5678`
- í† í°: `Bearer abc123...` â†’ `Bearer ***`
- ê¸°íƒ€ ë¯¼ê° í•„ë“œ ìë™ ê°ì§€ ë° ë§ˆìŠ¤í‚¹

### 6.2 Sentry ì „ì†¡ ì „ í•„í„°ë§

`ErrorResponseInterceptor`ì—ì„œ:
1. `SensitiveDataUtil.sanitizeError()`: ì—ëŸ¬ ê°ì²´ì˜ ë¯¼ê° ì •ë³´ ì œê±°
2. `SensitiveDataUtil.maskSensitiveFields()`: ì‘ë‹µ ë°ì´í„°ì˜ ë¯¼ê° ì •ë³´ ë§ˆìŠ¤í‚¹

---

## 7. ì—ëŸ¬ ë¶„ë¥˜ ë° ì „ì†¡ ê·œì¹™

### 7.1 ì—ëŸ¬ ë¶„ë¥˜

1. **5xx ì—ëŸ¬ (ì„œë²„ ì—ëŸ¬)**
   - í•­ìƒ Sentryë¡œ ì „ì†¡
   - ì˜ˆ: DB ì—°ê²° ì‹¤íŒ¨, ì™¸ë¶€ API í˜¸ì¶œ ì‹¤íŒ¨, ì˜ˆìƒì¹˜ ëª»í•œ ì˜ˆì™¸

2. **4xx ì—ëŸ¬ (í´ë¼ì´ì–¸íŠ¸ ì—ëŸ¬)**
   - Sentryë¡œ ì „ì†¡í•˜ì§€ ì•ŠìŒ
   - ì˜ˆ: ì˜ëª»ëœ ìš”ì²­, ê¶Œí•œ ì—†ìŒ, ë¦¬ì†ŒìŠ¤ ì—†ìŒ
   - ì´ìœ : ë…¸ì´ì¦ˆ ë°©ì§€ (ë„ˆë¬´ ë§ì€ í´ë¼ì´ì–¸íŠ¸ ì—ëŸ¬ê°€ Sentryì— ìŒ“ì„)

3. **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì—ëŸ¬**
   - ì„œë¹„ìŠ¤ì—ì„œ ì§ì ‘ `SentryUtil.captureException()` í˜¸ì¶œ
   - ì˜ˆ: DB ì—°ê²° ì‹¤íŒ¨, WebSocket ì—°ê²° ì—ëŸ¬

### 7.2 ì—ëŸ¬ ë ˆë²¨

`SentryUtil.getErrorLevel()`ì— ì˜í•´ ìë™ ê²°ì •:

- `500+`: `error`
- `400-499`: `warning` (í•˜ì§€ë§Œ ì „ì†¡í•˜ì§€ ì•ŠìŒ)
- ê¸°íƒ€: `info`
