## 스토어 등록(3단계) - 플로우

### 목적

판매자가 스토어를 개설하기 위한 3단계 등록 플로우를 정의하고, 프론트엔드와 백엔드의 실제 구현 흐름을 문서화합니다. 이 문서는 구현 코드 없이 절차, 검증, 예외 처리, 데이터 저장 원칙을 요약합니다.

### 사전 조건

- 로그인 필요 (쿠키 기반 인증).
- Seller API를 사용하며, 권한 데코레이터로 USER/SELLER/ADMIN 인증 사용.
- 외부 기관 연동을 통해 정상 영업 상태를 확인:
  - 국세청(사업자등록번호 진위확인)
  - 공정거래위원회(통신판매사업자 등록상세)

---

## 전체 흐름 개요

1. 사업자 정보 등록(진위확인)
2. 통신판매사업자 정보 등록(등록상세 조회)
3. 스토어 정보 입력 및 생성

각 단계에서 성공 시 다음 단계로 이동하며, 최종 3단계에서 서버가 1·2단계 요청 파라미터를 재검증 후 스토어를 생성합니다.

---

## 단계별 상세

### 1단계: 사업자등록번호 진위확인

- 목적: 사업자등록번호, 대표자명, 개업일자 기반으로 정상 영업 여부 확인.
- 프론트 흐름: 사업자 정보 폼 입력 → Seller API 호출 → 성공 시 2단계로 이동.
- 백엔드 엔드포인트: /v1/seller/business/validate (POST)
- 결과: 성공 시 “available: true” 성격의 성공 응답. 휴업/폐업 등 비정상 상태는 오류 처리.

### 2단계: 통신판매사업자 등록상세 조회

- 목적: 통신판매사업자 신고 상태 및 상세 정보 확인.
- 프론트 흐름: 1단계 응답의 사업자등록번호, 2단계 폼의 인허가관리번호로 조회 → 성공 시 3단계로 이동.
- 백엔드 엔드포인트: /v1/seller/business/online-trading-company/detail (GET, query)
- 결과: 성공 시 “available: true” 성격의 성공 응답. 미등록/폐업/운영 불가 등 오류는 코드별 매핑 처리.

### 3단계: 스토어 정보 입력 및 생성

- 목적: 스토어 기본 정보(이름, 설명, 로고 URL 등)를 입력하고 스토어를 생성.
- 프론트 흐름: 스토어 정보 폼 입력 → 1·2단계 요청 파라미터 + 스토어 정보로 생성 API 호출 → 성공 알림 후 홈으로 이동.
- 백엔드 엔드포인트: /v1/seller/store/create (POST)
- 서버 처리 핵심:
  - 1단계와 2단계의 사업자등록번호 일치 여부 검증(하이픈 제거 후 비교)
  - 동일 사용자 기준, 동일 사업자등록번호 + 인허가관리번호 조합 중복 생성 방지
  - 외부 조회 응답값은 저장하지 않고, 요청값만 저장(필요 시 외부 API로 최신 조회)
  - 사업자등록번호는 정규화(하이픈 제거)하여 저장

---

## 프론트엔드 구현 요약 (web-seller)

- 페이지: /store/create (3단계 마법사 UI)
- 상태 관리: 단계별 폼 상태 보존 및 단계 전환(이전/다음)
- API 호출 흐름:
  - 1단계: /business/validate (POST)
  - 2단계: /business/online-trading-company/detail (GET)
  - 3단계: /store/create (POST)
- 성공 처리: 성공 알림 노출 후 홈(/)으로 이동
- 실패 처리: 오류 메시지 매핑 후 알림 노출(인증 실패 시 사용자 페이지로 리다이렉트 처리 포함)

## 백엔드 구현 요약 (backend)

- Seller 컨트롤러:
  - /v1/seller/business/validate → 국세청 진위확인
  - /v1/seller/business/online-trading-company/detail → 공정위 등록상세 조회
  - /v1/seller/store/create → 스토어 생성(1·2단계 재검증 + 중복 방지 + 저장)
- 서비스 레이어:
  - 스토어 생성 시 1·2단계 재검증 수행
  - 사업자등록번호 정규화 저장, 외부 응답값 비저장 원칙 준수
  - 사용자별 중복 방지 규칙(사업자등록번호 + 인허가관리번호)

## 데이터 처리 원칙

- 저장: 사용자 입력값(요청 파라미터)만 저장
- 비저장: 외부 진위/상세 응답 데이터(상태 등)는 저장하지 않음
- 일관성: 사업자등록번호는 정규화(하이픈 제거)하여 저장 및 비교

## 오류/예외 처리

- 인증 오류(401): 쿠키 기반 인증 실패 시 판매자 → 사용자 로그인 페이지로 리다이렉트 흐름 적용
- 1단계 오류: 휴업/폐업/요청 형식 오류 등 코드별 응답 → 메시지 매핑으로 사용자 안내
- 2단계 오류: 미등록/운영 불가/요청 형식 오류 등 코드별 응답 → 메시지 매핑으로 사용자 안내
- 생성 단계 오류: 번호 불일치, 중복 스토어 생성 시도 등 사용자 친화적 메시지로 안내

---

## 향후 계획

- 본인(사업자) 인증: 등록 사업자 실소유자 확인을 위한 본인 인증 절차 도입 예정.
- 정상운영 점검(주기적 헬스체크):
  - 스케줄러/백그라운드 잡으로 정기적으로 1·2단계 외부 연동을 재조회
  - 비정상 상태 감지 시 스토어 상태 플래그 전환 및 알림(추가 정책 수립)

---

## 관련 문서 및 추가 반영 사항

- 통합 인증 - 가이드, 통합 플랫폼 인증(쿠키 기반) - 가이드: 판매자 영역(Seller)에서 401 발생 시 사용자 페이지로 리다이렉트하는 플로우를 본 문서와 연계하여 명시.
- web-seller README: 스토어 등록 페이지 경로(/store/create) 및 플로우 요약 추가.
- backend README: Seller API 항목에 사업/스토어 관련 엔드포인트(진위확인, 등록상세, 스토어 생성) 명시.
