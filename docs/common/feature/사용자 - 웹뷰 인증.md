# ì‚¬ìš©ì - ì›¹ë·° ì¸ì¦ ê°€ì´ë“œ

## ğŸ“‹ ê°œìš”

Sweet Order í”Œë«í¼ì˜ ì‚¬ìš©ì ì¸ì¦ ì‹œìŠ¤í…œì€ Flutter WebView í™˜ê²½ì—ì„œ ë™ì‘í•˜ë„ë¡ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤. Flutter ì•±ê³¼ ì›¹ë·° ê°„ì˜ í† í° ë™ê¸°í™”ë¥¼ í†µí•´ í†µí•©ëœ ì¸ì¦ ê²½í—˜ì„ ì œê³µí•©ë‹ˆë‹¤.

## ğŸ¯ ì£¼ìš” íŠ¹ì§•

- **Flutter WebView í†µí•©**: Flutter ì•±ê³¼ ì›¹ë·° ê°„ í† í° ë™ê¸°í™”
- **í—¤ë” ê¸°ë°˜ í† í° ì „ì†¡**: Authorization í—¤ë”ì— Bearer í† í° í¬í•¨
- **ë©”ëª¨ë¦¬ ê¸°ë°˜ í† í° ì €ì¥**: Zustand storeì— í† í° ì €ì¥ (localStorage ë¯¸ì‚¬ìš©)
- **ìë™ ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬**: 401 ì—ëŸ¬ ì‹œ Flutter ì•±ì— ë¡œê·¸ì•„ì›ƒ ë©”ì‹œì§€ ì „ì†¡

## ğŸ”„ ì „ì²´ ì¸ì¦ í”Œë¡œìš°

### 1. ë¡œê·¸ì¸ í”Œë¡œìš° (Flutter ì•± â†’ ë°±ì—”ë“œ â†’ WebView)

```mermaid
sequenceDiagram
    participant U as User
    participant F as Flutter App
    participant B as Backend
    participant DB as Database
    participant W as WebView

    U->>F: ë¡œê·¸ì¸ ì •ë³´ ì…ë ¥<br/>(userId, password)
    F->>B: POST /v1/user/auth/login<br/>{ userId, password }

    Note over B: 1. ì…ë ¥ ê²€ì¦ (DTO)
    B->>DB: User ì¡°íšŒ (userId)
    DB-->>B: ì‚¬ìš©ì ì •ë³´

    alt ê³„ì • ì—†ìŒ
        B-->>F: 400 - ê³„ì • ì—†ìŒ
    else ê³„ì • ì¡´ì¬
        B->>B: ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ (bcrypt)
        alt ë¹„ë°€ë²ˆí˜¸ í‹€ë¦¼
            B-->>F: 401 - ì¸ì¦ ì‹¤íŒ¨
        else ë¹„ë°€ë²ˆí˜¸ ë§ìŒ
            alt íœ´ëŒ€í° ë¯¸ì¸ì¦
                B-->>F: 400 - íœ´ëŒ€í° ì¸ì¦ í•„ìš”
            else íœ´ëŒ€í° ì¸ì¦ ì™„ë£Œ
                B->>B: JWT í† í° ìƒì„±<br/>(sub: userId, type: ACCESS, 90ì¼)
                B->>DB: lastLoginAt ì—…ë°ì´íŠ¸
                B-->>F: { accessToken, refreshToken }

                F->>F: Flutter ì•±ì— í† í° ì €ì¥<br/>(Secure Storage)
                F->>W: window.Auth.login(accessToken)
                W->>W: Zustand storeì— í† í° ì €ì¥<br/>(ë©”ëª¨ë¦¬)
                W-->>U: ë¡œê·¸ì¸ ì™„ë£Œ
            end
        end
    end
```

### 2. API ìš”ì²­ í”Œë¡œìš° (WebView â†’ ë°±ì—”ë“œ)

```mermaid
sequenceDiagram
    participant W as WebView
    participant B as Backend
    participant DB as Database

    W->>W: API ìš”ì²­ ì¤€ë¹„
    W->>W: Zustand storeì—ì„œ<br/>accessToken ì¡°íšŒ
    W->>B: GET /v1/user/products<br/>Authorization: Bearer {token}

    Note over B: 1. CORS ê²€ì¦
    Note over B: 2. @Auth ë°ì½”ë ˆì´í„° í™•ì¸
    Note over B: 3. AuthGuard ì‹¤í–‰

    B->>B: JwtStrategy.jwtFromRequest()<br/>Authorization í—¤ë”ì—ì„œ<br/>Bearer í† í° ì¶”ì¶œ

    alt í† í° ì—†ìŒ
        B-->>W: 401 - ACCESS_TOKEN_MISSING
    else í† í° ì¡´ì¬
        B->>B: JWT ì„œëª… ê²€ì¦<br/>(JWT_SECRET)
        alt ì„œëª… ì˜¤ë¥˜
            B-->>W: 401 - ACCESS_TOKEN_INVALID
        else ì„œëª… ìœ íš¨
            B->>B: í† í° ë§Œë£Œ ì‹œê°„ í™•ì¸
            alt í† í° ë§Œë£Œ
                B-->>W: 401 - ACCESS_TOKEN_EXPIRED
            else í† í° ìœ íš¨
                B->>B: JwtStrategy.validate()<br/>í† í° íƒ€ì… í™•ì¸ (ACCESS)
                B->>DB: User ì¡°íšŒ (sub: userId)<br/>ìµœì‹  role, isActive í™•ì¸

                alt ê³„ì • ì—†ìŒ/ë¹„í™œì„±í™”
                    B-->>W: 401 - ACCOUNT_NOT_FOUND/INACTIVE
                else ê³„ì • ìœ íš¨
                    B->>B: AuthGuard.handleRequest()<br/>ì—­í•  ê²€ì¦ (í•„ìš”ì‹œ)
                    B->>B: Controller ì‹¤í–‰
                    B->>DB: ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì²˜ë¦¬
                    DB-->>B: ë°ì´í„° ë°˜í™˜
                    B-->>W: 200 - ì„±ê³µ ì‘ë‹µ
                end
            end
        end
    end
```

### 3. 401 ì—ëŸ¬ ì²˜ë¦¬ í”Œë¡œìš° (WebView â†’ Flutter ì•±)

```mermaid
sequenceDiagram
    participant W as WebView
    participant B as Backend
    participant F as Flutter App

    W->>B: API ìš”ì²­<br/>Authorization: Bearer {token}

    alt í† í° ë§Œë£Œ/ë¬´íš¨
        B-->>W: 401 - ACCESS_TOKEN_INVALID<br/>{ message: "[ACCESS_TOKEN_INVALID] ..." }

        W->>W: Axios ì‘ë‹µ ì¸í„°ì…‰í„°<br/>401 ì—ëŸ¬ ê°ì§€
        W->>W: Zustand storeì—ì„œ<br/>í† í° ì œê±° (clearAccessToken)
        W->>F: window.Logout.postMessage("true")
        F->>F: Flutter ì•±ì—ì„œ<br/>í† í° ì œê±° (Secure Storage)
        F->>F: ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
    end
```

### 4. ìƒˆë¡œê³ ì¹¨ ì‹œ ë¡œê·¸ì¸ ìœ ì§€ í”Œë¡œìš°

```mermaid
sequenceDiagram
    participant U as User
    participant F as Flutter App
    participant W as WebView
    participant B as Backend

    U->>W: í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨

    W->>W: WebView ì´ˆê¸°í™”<br/>AuthProvider ë§ˆìš´íŠ¸
    W->>W: useWebViewBridge() ì‹¤í–‰<br/>window.Auth ê°ì²´ ë“±ë¡

    F->>F: Flutter ì•±ì—ì„œ<br/>ì €ì¥ëœ í† í° í™•ì¸<br/>(Secure Storage)

    alt í† í° ì¡´ì¬
        F->>W: window.Auth.login(accessToken)
        W->>W: Zustand storeì—<br/>í† í° ì €ì¥
        W->>B: API ìš”ì²­ ì‹œ<br/>Authorization í—¤ë” í¬í•¨
    else í† í° ì—†ìŒ
        F->>F: ë¡œê·¸ì¸ í˜ì´ì§€ í‘œì‹œ
    end
```

### 5. ë¡œê·¸ì•„ì›ƒ í”Œë¡œìš°

```mermaid
sequenceDiagram
    participant U as User
    participant F as Flutter App
    participant W as WebView

    U->>F: ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ í´ë¦­
    F->>F: Flutter ì•±ì—ì„œ<br/>í† í° ì œê±° (Secure Storage)
    F->>W: window.Auth.logout()
    W->>W: Zustand storeì—ì„œ<br/>í† í° ì œê±° (clearAccessToken)
    F->>F: ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
```
