# íŒë§¤ì ì¸ì¦ ê°€ì´ë“œ

## ğŸ“‹ ê°œìš”

Sweet Order í”Œë«í¼ì˜ íŒë§¤ì ì¸ì¦ ì‹œìŠ¤í…œì€ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ í™˜ê²½ì—ì„œ ë™ì‘í•˜ë„ë¡ ì„¤ê³„ë˜ì—ˆìŠµë‹ˆë‹¤. localStorageë¥¼ ì‚¬ìš©í•œ í† í° ê´€ë¦¬ì™€ ìë™ ë¡œê·¸ì¸ ìƒíƒœ ë³µì› ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.

## ğŸ¯ ì£¼ìš” íŠ¹ì§•

- **localStorage ê¸°ë°˜ í† í° ì €ì¥**: ë¸Œë¼ìš°ì € localStorageì— í† í° ì €ì¥
- **í—¤ë” ê¸°ë°˜ í† í° ì „ì†¡**: Authorization í—¤ë”ì— Bearer í† í° í¬í•¨
- **ìë™ ë¡œê·¸ì¸ ìƒíƒœ ë³µì›**: ìƒˆë¡œê³ ì¹¨ ì‹œ `/me` APIë¡œ ìë™ ë³µì›
- **ìë™ ë¦¬ë‹¤ì´ë ‰íŠ¸**: 401 ì—ëŸ¬ ì‹œ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ìë™ ì´ë™

## ğŸ”„ ì „ì²´ ì¸ì¦ í”Œë¡œìš°

### 1. ë¡œê·¸ì¸ í”Œë¡œìš° (ì›¹ ì•± â†’ ë°±ì—”ë“œ)

```mermaid
sequenceDiagram
    participant U as User
    participant F as Frontend
    participant B as Backend
    participant DB as Database

    U->>F: ë¡œê·¸ì¸ ì •ë³´ ì…ë ¥<br/>(userId, password)
    F->>B: POST /v1/user/auth/login<br/>{ userId, password }

    Note over B: 1. ì…ë ¥ ê²€ì¦ (DTO)
    B->>DB: User ì¡°íšŒ (userId)
    DB-->>B: ì‚¬ìš©ì ì •ë³´

    alt ê³„ì • ì—†ìŒ
        B-->>F: 400 - ê³„ì • ì—†ìŒ
    else ê³„ì • ì¡´ì¬
        B->>B: ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ (bcrypt)
        alt ë¹„ë°€ë²ˆí˜¸ í‹€ë¦¼
            B-->>F: 401 - ì¸ì¦ ì‹¤íŒ¨
        else ë¹„ë°€ë²ˆí˜¸ ë§ìŒ
            alt íœ´ëŒ€í° ë¯¸ì¸ì¦
                B-->>F: 400 - íœ´ëŒ€í° ì¸ì¦ í•„ìš”
            else íœ´ëŒ€í° ì¸ì¦ ì™„ë£Œ
                B->>B: JWT í† í° ìƒì„±<br/>(sub: userId, type: ACCESS, 90ì¼)
                B->>DB: lastLoginAt ì—…ë°ì´íŠ¸
                B-->>F: { accessToken, refreshToken }

                F->>F: localStorageì—<br/>í† í° ì €ì¥
                F->>F: Zustand store ì—…ë°ì´íŠ¸<br/>(isAuthenticated = true)
                F->>F: í™ˆ í˜ì´ì§€ë¡œ ì´ë™<br/>(returnUrl ìˆìœ¼ë©´ í•´ë‹¹ í˜ì´ì§€)
                F-->>U: ë¡œê·¸ì¸ ì™„ë£Œ
            end
        end
    end
```

### 2. API ìš”ì²­ í”Œë¡œìš° (ì›¹ ì•± â†’ ë°±ì—”ë“œ)

```mermaid
sequenceDiagram
    participant F as Frontend
    participant B as Backend
    participant DB as Database

    F->>F: API ìš”ì²­ ì¤€ë¹„
    F->>F: localStorageì—ì„œ<br/>accessToken ì¡°íšŒ
    F->>B: GET /v1/seller/stores<br/>Authorization: Bearer {token}

    Note over B: 1. CORS ê²€ì¦
    Note over B: 2. @Auth ë°ì½”ë ˆì´í„° í™•ì¸
    Note over B: 3. AuthGuard ì‹¤í–‰

    B->>B: JwtStrategy.jwtFromRequest()<br/>Authorization í—¤ë”ì—ì„œ<br/>Bearer í† í° ì¶”ì¶œ

    alt í† í° ì—†ìŒ
        B-->>F: 401 - ACCESS_TOKEN_MISSING
    else í† í° ì¡´ì¬
        B->>B: JWT ì„œëª… ê²€ì¦<br/>(JWT_SECRET)
        alt ì„œëª… ì˜¤ë¥˜
            B-->>F: 401 - ACCESS_TOKEN_INVALID
        else ì„œëª… ìœ íš¨
            B->>B: í† í° ë§Œë£Œ ì‹œê°„ í™•ì¸
            alt í† í° ë§Œë£Œ
                B-->>F: 401 - ACCESS_TOKEN_EXPIRED
            else í† í° ìœ íš¨
                B->>B: JwtStrategy.validate()<br/>í† í° íƒ€ì… í™•ì¸ (ACCESS)
                B->>DB: User ì¡°íšŒ (sub: userId)<br/>ìµœì‹  role, isActive í™•ì¸

                alt ê³„ì • ì—†ìŒ/ë¹„í™œì„±í™”
                    B-->>F: 401 - ACCOUNT_NOT_FOUND/INACTIVE
                else ê³„ì • ìœ íš¨
                    B->>B: AuthGuard.handleRequest()<br/>ì—­í•  ê²€ì¦ (SELLER ê¶Œí•œ í™•ì¸)
                    B->>B: Controller ì‹¤í–‰
                    B->>DB: ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì²˜ë¦¬
                    DB-->>B: ë°ì´í„° ë°˜í™˜
                    B-->>F: 200 - ì„±ê³µ ì‘ë‹µ
                end
            end
        end
    end
```

### 3. ìƒˆë¡œê³ ì¹¨ ì‹œ ë¡œê·¸ì¸ ìœ ì§€ í”Œë¡œìš°

```mermaid
sequenceDiagram
    participant U as User
    participant F as Frontend
    participant B as Backend
    participant DB as Database

    U->>F: í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨

    F->>F: AuthInitializerProvider ë§ˆìš´íŠ¸
    F->>F: localStorageì—ì„œ<br/>í† í° í™•ì¸

    alt í† í° ì¡´ì¬
        F->>B: GET /v1/user/auth/me<br/>Authorization: Bearer {token}

        Note over B: JWT ê²€ì¦ ê³¼ì • ë™ì¼
        B->>DB: User ì¡°íšŒ
        DB-->>B: ì‚¬ìš©ì ì •ë³´

        alt í† í° ìœ íš¨
            B-->>F: { accessToken, user }
            F->>F: Zustand storeì—<br/>ë¡œê·¸ì¸ ìƒíƒœ ì €ì¥<br/>(isAuthenticated = true)
            F->>F: isInitialized = true
            F-->>U: ë¡œê·¸ì¸ ìƒíƒœ ìœ ì§€
        else í† í° ë¬´íš¨
            B-->>F: 401 ì—ëŸ¬
            F->>F: localStorageì—ì„œ<br/>í† í° ì œê±°
            F->>F: Zustand store ì´ˆê¸°í™”<br/>(isAuthenticated = false)
            F->>F: ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        end
    else í† í° ì—†ìŒ
        F->>F: Zustand store ì´ˆê¸°í™”<br/>(isAuthenticated = false)
        F->>F: isInitialized = true
        F-->>U: ë¡œê·¸ì•„ì›ƒ ìƒíƒœ ìœ ì§€
    end
```

### 4. 401 ì—ëŸ¬ ì²˜ë¦¬ í”Œë¡œìš°

```mermaid
sequenceDiagram
    participant F as Frontend
    participant B as Backend

    F->>B: API ìš”ì²­<br/>Authorization: Bearer {token}

    alt í† í° ë§Œë£Œ/ë¬´íš¨
        B-->>F: 401 - ACCESS_TOKEN_INVALID<br/>{ message: "[ACCESS_TOKEN_INVALID] ..." }

        F->>F: Axios ì‘ë‹µ ì¸í„°ì…‰í„°<br/>401 ì—ëŸ¬ ê°ì§€
        F->>F: localStorageì—ì„œ<br/>í† í° ì œê±°
        F->>F: í˜„ì¬ URLì„ returnUrlë¡œ ì €ì¥
        F->>F: ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸<br/>?returnUrl={í˜„ì¬URL}
    end
```

### 5. ë¡œê·¸ì•„ì›ƒ í”Œë¡œìš°

```mermaid
sequenceDiagram
    participant U as User
    participant F as Frontend

    U->>F: ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ í´ë¦­
    F->>F: localStorageì—ì„œ<br/>í† í° ì œê±°
    F->>F: Zustand store ì´ˆê¸°í™”<br/>(isAuthenticated = false)
    F->>F: ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
```
