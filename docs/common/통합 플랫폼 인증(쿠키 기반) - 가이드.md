# 통합 플랫폼 인증(쿠키 기반) - 가이드

## 📋 개요

Sweet Order 플랫폼의 통합 인증 시스템은 사용자(User), 판매자(Seller), 관리자(Admin)의 3-way 분리된 API 구조에서 쿠키 기반 토큰 전송을 통해 서브도메인 간 통합 로그인을 제공합니다.


## 🔄 토큰 전송 방식 변경 (쿠키)

### 변경 배경
- **기존**: 헤더 기반 토큰 전송 (Authorization Bearer)
- **현재**: 쿠키 기반 토큰 전송

### 쿠키 방식 사용 이유
헤더에 담아서 전달하는 방식을 사용하면 토큰이 브라우저 스토리지에 담아야 하는데, 이는 서브도메인 공유가 안됩니다.

- **브라우저 스토리지 제한**: localStorage, sessionStorage는 동일 출처 정책으로 인해 서브도메인 간 공유 불가
- **서브도메인 통합 로그인**: 사용자, 판매자, 관리자 도메인 간 토큰 공유 필요
- **쿠키 도메인 설정**: `.sweetorders.com` 도메인으로 설정하여 모든 서브도메인에서 토큰 접근 가능
- **보안 강화**: HttpOnly, Secure, SameSite 설정으로 XSS/CSRF 공격 방지

## 🎯 주요 특징

- **쿠키 기반 토큰 전송**: 서브도메인 통합 로그인을 위한 쿠키 방식
- **3-way API 분리**: User, Seller, Admin 역할별 독립적인 API
- **하나의 데코레이터로 모든 인증/권한 처리**


## 🖥️ 백엔드 처리

### 1. CORS 설정
**CORS 설정 옵션**:
```typescript
allowedHeaders: ["Content-Type", "X-Requested-With", "Cookie"], // 클라이언트에서 서버로 보낼 수 있는 헤더들 (Cookie 헤더 포함)
exposedHeaders: ["Set-Cookie"], // 서버에서 클라이언트로 보낼 수 있는 헤더들 (서버가 쿠키를 설정할 때 필요)
credentials: true, // 쿠키, 인증 헤더 등을 포함한 자격 증명을 CORS 요청에 포함할 수 있도록 허용
```

### 2. 쿠키 기반 토큰 설정
**쿠키 설정 옵션**:
```typescript
domain: ".sweetorders.com", // 서브도메인 통합을 위한 도메인 (개발환경 localhost는 도메인 제한이 없어서 배포 환경만 도메인 제한)
httpOnly: true, // JavaScript 접근 차단 (XSS 공격 방지)
secure: false, // HTTPS 전용 (개발환경에서는 SECURE 쿠키 설정 안함)
sameSite: "lax", // CSRF 공격 방지 (lax: 서브도메인 간 쿠키 전송 허용)(strict: 서브도메인 간 쿠키 전송 불가)
cookieMaxAge: **, // 쿠키 만료 시간
```

### 3. JWT 전략에서 쿠키에서 토큰 추출
- 요청 시 쿠키에서 `access_token` 추출
- 토큰이 없으면 401 에러 반환
- 토큰 검증 후 사용자 정보를 `req.user`에 저장

### 4. 토큰 갱신 API
- 쿠키에서 `refresh_token` 추출
- Refresh Token 검증 후 새 Access Token 생성
- 새 Access Token을 쿠키에 설정하여 응답

### 5. 로그아웃 API
- 쿠키에서 모든 인증 토큰 삭제
- 클라이언트의 로그아웃 상태 완료

### 6. API 권한 관리

3-way 분리된 API 구조(User, Seller, Admin)에서 역할 기반 접근 제어를 제공합니다. 하나의 통합된 `@Auth` 데코레이터를 통해 모든 인증과 권한을 효율적으로 관리할 수 있습니다.

**API 구조**:
- **User API**: `/v1/user/*` - 일반 사용자용 API
- **Seller API**: `/v1/seller/*` - 판매자용 API  
- **Admin API**: `/v1/admin/*` - 관리자용 API

**권한 설정 예시**:
- **`@Auth({ isPublic: true })`**: 인증 없이 접근 가능한 엔드포인트
- **`@Auth({ isPublic: false })`**: 기본 인증 (모든 인증된 사용자)
- **`@Auth({ isPublic: false, roles: ['USER'] })`**: USER 역할만 접근 가능
- **`@Auth({ isPublic: false, roles: ['SELLER'] })`**: SELLER 역할만 접근 가능
- **`@Auth({ isPublic: false, roles: ['ADMIN'] })`**: ADMIN 역할만 접근 가능
- **`@Auth({ isPublic: false, roles: ['SELLER', 'ADMIN'] })`**: SELLER와 ADMIN 역할만 접근 가능

## 🌐 프론트엔드 처리

### 1. Axios 설정 (withCredentials)
```typescript
const axiosConfig = {
  withCredentials: true, // 쿠키 자동 전송을 위한 필수 설정
};
```

**중요**: `withCredentials: true` 설정이 없으면 쿠키가 서버로 전송되지 않습니다.


## 📚 참고사항

### 🔧 기술적 구현 세부사항

- **쿠키 기반 인증**: 토큰은 쿠키로 자동 전송되며, 서브도메인 간 공유 가능

### 🚨 주의사항

1. **withCredentials 필수 설정**: 프론트엔드에서 `withCredentials: true` 설정이 없으면 쿠키가 전송되지 않음
2. **CORS 설정 필수**: `credentials: true`, `allowedHeaders`에 "Cookie" 포함, `exposedHeaders`에 "Set-Cookie" 포함
3. **쿠키 도메인 설정**: 개발환경에서는 도메인 제한 없음, 배포환경에서만 `.sweetorders.com` 도메인 설정
4. **토큰 만료 시간**: Access Token 1시간, Refresh Token 30일로 설정
5. **쿠키 만료 시간**: Access Token 1시간, Refresh Token 30일로 설정
6. **보안 설정**: HttpOnly, Secure, SameSite 옵션으로 XSS/CSRF 공격 방지

