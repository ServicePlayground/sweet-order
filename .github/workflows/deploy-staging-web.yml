name: Deploy to Vercel (Staging)

on:
  push:
    tags:
      - "web-user/staging-*"
      - "web-seller/staging-*"

jobs:
  deploy-vercel:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract project name and environment from tag
        id: extract-project
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          PROJECT_NAME=$(echo $TAG_NAME | cut -d'/' -f1)
          ENV_NAME=$(echo $TAG_NAME | cut -d'/' -f2 | cut -d'-' -f1)
          echo "project=$PROJECT_NAME" >> $GITHUB_OUTPUT
          echo "environment=$ENV_NAME" >> $GITHUB_OUTPUT
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Tag: $TAG_NAME"
          echo "ðŸ“ Project: $PROJECT_NAME"
          echo "ðŸŒ Environment: $ENV_NAME"

      - name: Validate project name and environment
        run: |
          PROJECT=${{ steps.extract-project.outputs.project }}
          ENV=${{ steps.extract-project.outputs.environment }}

          if [[ "$PROJECT" != "web-user" && "$PROJECT" != "web-seller" ]]; then
            echo "âŒ Invalid project name: $PROJECT"
            echo "Valid project names: web-user, web-seller"
            exit 1
          fi

          if [[ "$ENV" != "staging" ]]; then
            echo "âŒ Invalid environment: $ENV"
            echo "Valid environment: staging"
            exit 1
          fi

          echo "âœ… Valid project: $PROJECT"
          echo "âœ… Valid environment: $ENV"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Enable Corepack and prepare Yarn
        run: corepack enable && corepack prepare yarn@4.9.4 --activate

      - name: Install dependencies
        run: yarn install

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Set project-specific variables
        id: set-vars
        run: |
          PROJECT=${{ steps.extract-project.outputs.project }}

          # íƒœê·¸ì— ë”°ë¼ í•˜ë‚˜ì˜ í”„ë¡œì íŠ¸ë§Œ ë°°í¬ë©ë‹ˆë‹¤
          # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ì™€ í”„ë¡œì íŠ¸ IDë§Œ ì„¤ì •
          # buildCommand, outputDirectoryëŠ” vercel.jsonì—ì„œ ìžë™ìœ¼ë¡œ ì½ì–´ì˜µë‹ˆë‹¤
          case $PROJECT in
            web-user)
              echo "project_dir=apps/web-user" >> $GITHUB_OUTPUT
              echo "project_id=${{ secrets.VERCEL_PROJECT_ID_WEB_USER_STAGING }}" >> $GITHUB_OUTPUT
              ;;
            web-seller)
              echo "project_dir=apps/web-seller" >> $GITHUB_OUTPUT
              echo "project_id=${{ secrets.VERCEL_PROJECT_ID_WEB_SELLER_STAGING }}" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Deploy to Vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_TEAM_ID: ${{ secrets.VERCEL_TEAM_ID }}
        run: |
          PROJECT=${{ steps.extract-project.outputs.project }}
          TAG_NAME=${{ steps.extract-project.outputs.tag }}
          PROJECT_DIR=${{ steps.set-vars.outputs.project_dir }}
          PROJECT_ID=${{ steps.set-vars.outputs.project_id }}

          echo "ðŸš€ Deploying $PROJECT (staging) to Vercel..."
          echo "ðŸ“ Project Directory: $PROJECT_DIR"
          echo "ðŸ†” Project ID: ${PROJECT_ID:-not set}"
          echo "ðŸ¢ Team ID: ${VERCEL_TEAM_ID:-not set}"
          echo "ðŸ“‹ Build settings will be read from vercel.json in $PROJECT_DIR"

          if [ -z "$PROJECT_ID" ]; then
            echo "âš ï¸  Warning: Project ID is not set. Vercel will try to auto-detect the project."
          fi

          if [ -z "$VERCEL_TEAM_ID" ]; then
            echo "âš ï¸  Warning: Team ID is not set. Vercel will try to auto-detect the team."
          fi

          # í™˜ê²½ ë³€ìˆ˜ë¡œ Vercel ì„¤ì •
          export VERCEL_TOKEN=$VERCEL_TOKEN
          if [ -n "$VERCEL_TEAM_ID" ]; then
            export VERCEL_TEAM_ID=$VERCEL_TEAM_ID
            # VERCEL_ORG_IDëŠ” VERCEL_TEAM_IDì™€ ë™ì¼í•œ ê°’ìž…ë‹ˆë‹¤
            export VERCEL_ORG_ID=$VERCEL_TEAM_ID
          fi
          if [ -n "$PROJECT_ID" ]; then
            export VERCEL_PROJECT_ID=$PROJECT_ID
          fi

          # Vercel ë°°í¬ ì‹¤í–‰
          # vercel.jsonì˜ buildCommand, outputDirectory, rootDirectory ë“±ì„ ìžë™ìœ¼ë¡œ ì½ì–´ì˜µë‹ˆë‹¤
          echo "ðŸ“¤ Deploying to Vercel (Staging)..."
          vercel deploy --prod --token=$VERCEL_TOKEN --cwd=$PROJECT_DIR --yes

          if [ $? -ne 0 ]; then
            echo "âŒ Deployment failed!"
            exit 1
          fi

          echo "âœ… Deployment completed for $PROJECT (staging)"

      - name: Deployment summary
        run: |
          echo "## ðŸŽ‰ Vercel Deployment Summary (Staging)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Project:** ${{ steps.extract-project.outputs.project }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** staging" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ steps.extract-project.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** âœ… Successfully deployed to Vercel" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. Vercel ëŒ€ì‹œë³´ë“œì—ì„œ í™•ì¸í•˜ì„¸ìš”." >> $GITHUB_STEP_SUMMARY
