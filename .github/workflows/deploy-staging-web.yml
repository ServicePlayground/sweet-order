name: Deploy to Vercel (Staging)

# Ìä∏Î¶¨Í±∞: web-user ÎòêÎäî web-sellerÏùò staging ÌÉúÍ∑∏Í∞Ä Ìë∏ÏãúÎê† Îïå Ïã§Ìñâ
on:
  push:
    tags:
      - "web-user/staging-*"
      - "web-seller/staging-*"

jobs:
  deploy-vercel:
    runs-on: ubuntu-latest

    steps:
      # ÌÉúÍ∑∏ÏóêÏÑú ÌîÑÎ°úÏ†ùÌä∏Î™ÖÍ≥º ÌôòÍ≤Ω Ï∂îÏ∂ú (Ïòà: web-user/staging-v1.0.0)
      - name: Extract project name and environment from tag
        id: extract-project
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          PROJECT_NAME=$(echo $TAG_NAME | cut -d'/' -f1)
          ENV_NAME=$(echo $TAG_NAME | cut -d'/' -f2 | cut -d'-' -f1)
          echo "project=$PROJECT_NAME" >> $GITHUB_OUTPUT
          echo "environment=$ENV_NAME" >> $GITHUB_OUTPUT
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "üì¶ Tag: $TAG_NAME"
          echo "üìÅ Project: $PROJECT_NAME"
          echo "üåç Environment: $ENV_NAME"

      # ÌîÑÎ°úÏ†ùÌä∏Î™ÖÍ≥º ÌôòÍ≤Ω Ïú†Ìö®ÏÑ± Í≤ÄÏ¶ù
      - name: Validate project name and environment
        run: |
          PROJECT=${{ steps.extract-project.outputs.project }}
          ENV=${{ steps.extract-project.outputs.environment }}

          if [[ "$PROJECT" != "web-user" && "$PROJECT" != "web-seller" ]]; then
            echo "‚ùå Invalid project name: $PROJECT"
            echo "Valid project names: web-user, web-seller"
            exit 1
          fi

          if [[ "$ENV" != "staging" ]]; then
            echo "‚ùå Invalid environment: $ENV"
            echo "Valid environment: staging"
            exit 1
          fi

          echo "‚úÖ Valid project: $PROJECT"
          echo "‚úÖ Valid environment: $ENV"

      # ÌîÑÎ°úÏ†ùÌä∏Î≥Ñ Vercel ÏõπÌõÖ URL ÏÑ§Ï†ï
      - name: Set project-specific webhook URL
        id: set-webhook
        run: |
          PROJECT=${{ steps.extract-project.outputs.project }}

          case $PROJECT in
            web-user)
              echo "webhook_url=${{ secrets.VERCEL_WEBHOOK_URL_WEB_USER_STAGING }}" >> $GITHUB_OUTPUT
              ;;
            web-seller)
              echo "webhook_url=${{ secrets.VERCEL_WEBHOOK_URL_WEB_SELLER_STAGING }}" >> $GITHUB_OUTPUT
              ;;
          esac

      # Vercel ÏõπÌõÖÏùÑ ÌÜµÌïú Î∞∞Ìè¨ Ìä∏Î¶¨Í±∞
      - name: Trigger Vercel deployment via webhook
        run: |
          PROJECT=${{ steps.extract-project.outputs.project }}
          TAG_NAME=${{ steps.extract-project.outputs.tag }}
          WEBHOOK_URL=${{ steps.set-webhook.outputs.webhook_url }}

          echo "üöÄ Triggering deployment for $PROJECT (staging) via Vercel webhook..."
          echo "üìã Tag: $TAG_NAME"
          echo "üîó Webhook URL: ${WEBHOOK_URL:0:50}..." # URL ÏùºÎ∂ÄÎßå ÌëúÏãú (Î≥¥Ïïà)

          if [ -z "$WEBHOOK_URL" ]; then
            echo "‚ùå Error: Webhook URL is not set for $PROJECT"
            echo "Please set VERCEL_WEBHOOK_URL_${PROJECT^^}_STAGING secret in GitHub repository settings"
            exit 1
          fi

          # Vercel ÏõπÌõÖ Ìò∏Ï∂ú
          echo "üì§ Calling Vercel webhook..."
          HTTP_STATUS=$(curl -s -o /tmp/vercel_response.txt -w "%{http_code}" \
            -X POST \
            -H "Content-Type: application/json" \
            "$WEBHOOK_URL")

          if [ "$HTTP_STATUS" -ge 200 ] && [ "$HTTP_STATUS" -lt 300 ]; then
            echo "‚úÖ Webhook triggered successfully (HTTP $HTTP_STATUS)"
            cat /tmp/vercel_response.txt 2>/dev/null || echo "No response body"
          else
            echo "‚ùå Webhook call failed (HTTP $HTTP_STATUS)"
            cat /tmp/vercel_response.txt
            exit 1
          fi
