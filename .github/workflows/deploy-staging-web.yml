name: Deploy to Vercel (Staging)

# íŠ¸ë¦¬ê±°: web-user ë˜ëŠ” web-sellerì˜ staging íƒœê·¸ê°€ í‘¸ì‹œë  ë•Œ ì‹¤í–‰
on:
  push:
    tags:
      - "web-user/staging-*"
      - "web-seller/staging-*"

jobs:
  deploy-vercel:
    runs-on: ubuntu-latest

    steps:
      # íƒœê·¸ì—ì„œ í”„ë¡œì íŠ¸ëª…ê³¼ í™˜ê²½ ì¶”ì¶œ (ì˜ˆ: web-user/staging-v1.0.0)
      - name: Extract project name and environment from tag
        id: extract-project
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          PROJECT_NAME=$(echo $TAG_NAME | cut -d'/' -f1)
          ENV_NAME=$(echo $TAG_NAME | cut -d'/' -f2 | cut -d'-' -f1)
          echo "project=$PROJECT_NAME" >> $GITHUB_OUTPUT
          echo "environment=$ENV_NAME" >> $GITHUB_OUTPUT
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Tag: $TAG_NAME"
          echo "ðŸ“ Project: $PROJECT_NAME"
          echo "ðŸŒ Environment: $ENV_NAME"

      # í”„ë¡œì íŠ¸ëª…ê³¼ í™˜ê²½ ìœ íš¨ì„± ê²€ì¦
      - name: Validate project name and environment
        run: |
          PROJECT=${{ steps.extract-project.outputs.project }}
          ENV=${{ steps.extract-project.outputs.environment }}

          if [[ "$PROJECT" != "web-user" && "$PROJECT" != "web-seller" ]]; then
            echo "âŒ Invalid project name: $PROJECT"
            echo "Valid project names: web-user, web-seller"
            exit 1
          fi

          if [[ "$ENV" != "staging" ]]; then
            echo "âŒ Invalid environment: $ENV"
            echo "Valid environment: staging"
            exit 1
          fi

          echo "âœ… Valid project: $PROJECT"
          echo "âœ… Valid environment: $ENV"

      # í”„ë¡œì íŠ¸ë³„ Vercel ì›¹í›… URL ì„¤ì •
      - name: Set project-specific webhook URL
        id: set-webhook
        run: |
          PROJECT=${{ steps.extract-project.outputs.project }}

          case $PROJECT in
            web-user)
              echo "webhook_url=${{ secrets.VERCEL_WEBHOOK_URL_WEB_USER_STAGING }}" >> $GITHUB_OUTPUT
              ;;
            web-seller)
              echo "webhook_url=${{ secrets.VERCEL_WEBHOOK_URL_WEB_SELLER_STAGING }}" >> $GITHUB_OUTPUT
              ;;
          esac

      # Vercel ì›¹í›…ì„ í†µí•œ ë°°í¬ íŠ¸ë¦¬ê±°
      - name: Trigger Vercel deployment via webhook
        run: |
          PROJECT=${{ steps.extract-project.outputs.project }}
          TAG_NAME=${{ steps.extract-project.outputs.tag }}
          WEBHOOK_URL=${{ steps.set-webhook.outputs.webhook_url }}

          echo "ðŸš€ Triggering deployment for $PROJECT (staging) via Vercel webhook..."
          echo "ðŸ“‹ Tag: $TAG_NAME"
          echo "ðŸ”— Webhook URL: ${WEBHOOK_URL:0:50}..." # URL ì¼ë¶€ë§Œ í‘œì‹œ (ë³´ì•ˆ)

          if [ -z "$WEBHOOK_URL" ]; then
            echo "âŒ Error: Webhook URL is not set for $PROJECT"
            echo "Please set VERCEL_WEBHOOK_URL_${PROJECT^^}_STAGING secret in GitHub repository settings"
            exit 1
          fi

          # Vercel ì›¹í›… í˜¸ì¶œ
          echo "ðŸ“¤ Calling Vercel webhook..."
          HTTP_STATUS=$(curl -s -o /tmp/vercel_response.txt -w "%{http_code}" \
            -X POST \
            -H "Content-Type: application/json" \
            "$WEBHOOK_URL")

          if [ "$HTTP_STATUS" -ge 200 ] && [ "$HTTP_STATUS" -lt 300 ]; then
            echo "âœ… Webhook triggered successfully (HTTP $HTTP_STATUS)"
            cat /tmp/vercel_response.txt 2>/dev/null || echo "No response body"
          else
            echo "âŒ Webhook call failed (HTTP $HTTP_STATUS)"
            cat /tmp/vercel_response.txt
            exit 1
          fi

      # ë°°í¬ ê²°ê³¼ ìš”ì•½ ìƒì„± (GitHub Actions UIì— í‘œì‹œ)
      - name: Deployment summary
        run: |
          echo "## ðŸŽ‰ Vercel Deployment Summary (Staging)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Project:** ${{ steps.extract-project.outputs.project }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** staging" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** ${{ steps.extract-project.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** âœ… Successfully deployed to Vercel" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. Vercel ëŒ€ì‹œë³´ë“œì—ì„œ í™•ì¸í•˜ì„¸ìš”." >> $GITHUB_STEP_SUMMARY
