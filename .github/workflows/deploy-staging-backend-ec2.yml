name: Deploy Backend to EC2 (Staging)

permissions:
  contents: read

on:
  push:
    tags:
      - "backend/staging-*"

jobs:
  deploy-staging:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Enable Corepack
        run: corepack enable

      - name: Setup Yarn
        run: corepack prepare yarn@4.9.4 --activate

      - name: Install dependencies
        run: yarn install

      - name: Build backend
        run: yarn run backend:build:staging

      - name: Prepare deployment package
        run: |
          # ë¹Œë“œ ì‚°ì¶œë¬¼ê³¼ ì˜ì¡´ì„± íŒŒì¼ë§Œ í¬í•¨í•˜ëŠ” ë°°í¬ íŒ¨í‚¤ì§€ ìƒì„± (node_modules ì œì™¸)
          mkdir -p /tmp/deploy-package/apps/backend
          
          # ë£¨íŠ¸ íŒŒì¼ ë³µì‚¬ (package.json, yarn.lock, .yarnrc.yml)
          echo "ğŸ“¦ ë£¨íŠ¸ ì˜ì¡´ì„± íŒŒì¼ ë³µì‚¬ ì¤‘..."
          cp package.json /tmp/deploy-package/
          cp yarn.lock /tmp/deploy-package/
          cp .yarnrc.yml /tmp/deploy-package/
          
          # ë°±ì—”ë“œ ë¹Œë“œ ì‚°ì¶œë¬¼ ë° package.json ë³µì‚¬
          echo "ğŸ“¦ ë°±ì—”ë“œ ë¹Œë“œ ì‚°ì¶œë¬¼ ë³µì‚¬ ì¤‘..."
          cp -r apps/backend/dist /tmp/deploy-package/apps/backend/
          cp apps/backend/package.json /tmp/deploy-package/apps/backend/
          
          # ì••ì¶•
          cd /tmp
          tar -czf deploy.tar.gz -C deploy-package .
          mv deploy.tar.gz ${{ github.workspace }}/

      - name: Copy deployment package to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.STAGING_EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.STAGING_EC2_SSH_KEY }}
          source: "deploy.tar.gz"
          target: "~/"

      - name: Deploy to EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.STAGING_EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.STAGING_EC2_SSH_KEY }}
          script: |
            set -Ee  # í•¨ìˆ˜ ë‚´ë¶€ ì—ëŸ¬ë„ trap

            # ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ ê³„ì‚° í•¨ìˆ˜ (í•œ ë²ˆë§Œ ê³„ì‚°)
            get_disk_usage() {
              df / | awk 'END {gsub("%","",$5); print $5}'
            }

            # ë¡¤ë°± í•¨ìˆ˜ ì •ì˜
            rollback_deployment() {
              echo ""
              echo "ğŸ”„ ë°°í¬ ì‹¤íŒ¨ë¡œ ì¸í•œ ë¡¤ë°± ì‹œì‘..."
              
              pm2 delete sweet-order-backend 2>/dev/null || true
              
              LATEST_BACKUP=$(ls -td ~/sweet-order.backup.* 2>/dev/null | head -1)
              
              if [ -n "$LATEST_BACKUP" ] && [ -d "$LATEST_BACKUP" ]; then
                echo "ğŸ“¦ ë°±ì—… ë³µì› ì¤‘: $LATEST_BACKUP"
                rm -rf ~/sweet-order
                mv "$LATEST_BACKUP" ~/sweet-order
                
                if [ -f ~/sweet-order/apps/backend/dist/main.js ]; then
                  cd ~/sweet-order/apps/backend
                  NODE_ENV=staging pm2 start dist/main.js \
                    --name sweet-order-backend \
                    --update-env \
                    --cwd $(pwd)
                  pm2 save
                  echo "âœ… ë¡¤ë°± ì™„ë£Œ"
                else
                  echo "âš ï¸ ë¡¤ë°± ì‹¤íŒ¨ - ë°±ì—…ì— ë¹Œë“œ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤"
                fi
              else
                echo "âŒ ë¡¤ë°± ì‹¤íŒ¨ - ë°±ì—…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
              fi
              
              exit 1
            }

            # ë°°í¬ ì‹¤íŒ¨ ì‹œ ë¡¤ë°±ì„ ìœ„í•œ trap ì„¤ì • (ë§¨ ìœ„ì—ì„œ ì„¤ì •í•˜ì—¬ ì „ì²´ êµ¬ê°„ ë³´í˜¸)
            trap rollback_deployment ERR

            # ë°±ì—… íŒŒì¼ ê°œìˆ˜ ì œí•œ í•¨ìˆ˜ (ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ì— ë”°ë¼ ë™ì  ì¡°ì •)
            # ë³´ì¡° ìˆ˜ë‹¨ìœ¼ë¡œë§Œ ì‚¬ìš©: ë””ìŠ¤í¬ ë¶€ì¡± ì‹œì™€ ë°°í¬ ì„±ê³µ í›„ì—ë§Œ ì‹¤í–‰
            cleanup_old_backups() {
              local BACKUP_TYPE=$1
              local BACKUP_PATTERN=$2
              local USE_PERCENT=$3
              local KEEP_COUNT=5
              
              # ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ì— ë”°ë¼ ë°±ì—… ê°œìˆ˜ ì¡°ì •
              if [ "$USE_PERCENT" -ge 90 ]; then
                KEEP_COUNT=2
                echo "âš ï¸ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ì´ ë†’ì•„ ë°±ì—…ì„ ìµœê·¼ ${KEEP_COUNT}ê°œë§Œ ìœ ì§€í•©ë‹ˆë‹¤"
              elif [ "$USE_PERCENT" -ge 85 ]; then
                KEEP_COUNT=3
                echo "âš ï¸ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ì´ ë†’ì•„ ë°±ì—…ì„ ìµœê·¼ ${KEEP_COUNT}ê°œë§Œ ìœ ì§€í•©ë‹ˆë‹¤"
              fi
              
              echo "ğŸ§¹ ì˜¤ë˜ëœ ${BACKUP_TYPE} ë°±ì—… ì •ë¦¬ ì¤‘ (ìµœê·¼ ${KEEP_COUNT}ê°œë§Œ ìœ ì§€)..."
              
              # ì•ˆì „í•œ ë°±ì—… ì‚­ì œ: ê²½ë¡œ ê²€ì¦ ê°•í™”
              local HOME_DIR=$(eval echo ~)
              local count=0
              
              # ë°±ì—… íŒŒì¼ ëª©ë¡ì„ ì„ì‹œ íŒŒì¼ì— ì €ì¥í•˜ì—¬ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
              local temp_list=$(mktemp)
              ls -t ${BACKUP_PATTERN} 2>/dev/null | tail -n +$((KEEP_COUNT + 1)) > "$temp_list" || true
              
              while IFS= read -r old_backup || [ -n "$old_backup" ]; do
                # ê²½ë¡œ ê²€ì¦: í™ˆ ë””ë ‰í† ë¦¬ ë‚´ ë°±ì—…ë§Œ ì‚­ì œ, ë¹ˆ ì¤„ ë¬´ì‹œ
                [ -z "$old_backup" ] && continue
                
                # í™ˆ ë””ë ‰í† ë¦¬ ê²½ë¡œë¡œ í™•ì¥
                local expanded_path=$(eval echo "$old_backup")
                
                # í™ˆ ë””ë ‰í† ë¦¬ ë‚´ì— ìˆê³  ì‹¤ì œ ì¡´ì¬í•˜ëŠ” íŒŒì¼/ë””ë ‰í† ë¦¬ë§Œ ì‚­ì œ
                if [[ "$expanded_path" == "$HOME_DIR"* ]] && [ -e "$expanded_path" ]; then
                  echo "  ì‚­ì œ: $old_backup"
                  rm -rf "$expanded_path"
                  count=$((count + 1))
                fi
              done < "$temp_list"
              
              rm -f "$temp_list"
              
              if [ $count -eq 0 ]; then
                echo "  ì‚­ì œí•  ë°±ì—…ì´ ì—†ìŠµë‹ˆë‹¤"
              fi
            }

            # ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ ì²´í¬ (í•œ ë²ˆë§Œ ê³„ì‚°)
            USE_PERCENT=$(get_disk_usage)
            echo "ğŸ“Š ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰: ${USE_PERCENT}%"

            # ë””ìŠ¤í¬ ë¶€ì¡± ì‹œì—ë§Œ ì •ë¦¬ ì‘ì—… ì‹¤í–‰ (ë³´ì¡° ìˆ˜ë‹¨)
            if [ "$USE_PERCENT" -gt 80 ]; then
              echo "âš ï¸ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ì´ ë†’ìŠµë‹ˆë‹¤. ì •ë¦¬ ì‘ì—… ì‹œì‘..."
              
              cleanup_old_backups "ì„œë²„" "~/sweet-order.backup.*" "$USE_PERCENT"
              cleanup_old_backups "DB" "~/db-backup.*.dump" "$USE_PERCENT"
              
              # PM2 ë¡œê·¸ ì •ë¦¬ë§Œ ìˆ˜í–‰ (ì‹¤í–‰ ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ íŒŒì¼ì€ ê±´ë“œë¦¬ì§€ ì•ŠìŒ)
              pm2 flush || true
              
              # ì •ë¦¬ í›„ ì¬í™•ì¸
              USE_PERCENT=$(get_disk_usage)
              echo "ì •ë¦¬ í›„ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰: ${USE_PERCENT}%"
              
              if [ "$USE_PERCENT" -gt 95 ]; then
                echo "âŒ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ ${USE_PERCENT}% â€” ê³µê°„ ë¶€ì¡±. ë°°í¬ ì¤‘ë‹¨"
                exit 1
              fi
            fi

            # ğŸ—„ï¸ DB ë°±ì—… ìƒì„± (ë°°í¬ ì „)
            # Custom format ì‚¬ìš© (.dump í™•ì¥ì)
            echo "ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—… ìƒì„± ì¤‘..."
            DB_BACKUP_NAME=~/db-backup.$(date +%Y%m%d_%H%M%S).dump
            PGPASSWORD='${{ secrets.STAGING_DATABASE_PASSWORD }}' \
              pg_dump -h localhost -p 5432 -U sweetorder_admin \
              -d sweetorder_staging_db \
              -Fc -f "$DB_BACKUP_NAME" 2>/dev/null || {
              echo "âš ï¸ DB ë°±ì—… ì‹¤íŒ¨ (ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤)"
              rm -f "$DB_BACKUP_NAME"
            }

            if [ -f "$DB_BACKUP_NAME" ]; then
              echo "âœ… DB ë°±ì—… ì™„ë£Œ: $DB_BACKUP_NAME"
            fi

            # ê¸°ì¡´ í”„ë¡œì íŠ¸ ë°±ì—…
            if [ -d ~/sweet-order ]; then
              CURRENT_BACKUP_NAME=~/sweet-order.backup.$(date +%Y%m%d_%H%M%S)
              echo "ğŸ“¦ ê¸°ì¡´ í”„ë¡œì íŠ¸ ë°±ì—… ì¤‘: $CURRENT_BACKUP_NAME"
              mv ~/sweet-order "$CURRENT_BACKUP_NAME" || {
                echo "âš ï¸ ë°±ì—… ì‹¤íŒ¨, ê¸°ì¡´ ë””ë ‰í† ë¦¬ ì‚­ì œ í›„ ì§„í–‰"
                rm -rf ~/sweet-order
              }
            fi

            mkdir -p ~/sweet-order
            cd ~/sweet-order

            echo "ğŸ“‚ ë°°í¬ íŒ¨í‚¤ì§€ ì••ì¶• í•´ì œ"
            tar -xzf ~/deploy.tar.gz
            rm ~/deploy.tar.gz

            if [ ! -d "apps/backend/dist" ]; then
              echo "âŒ ë¹Œë“œ ì‚°ì¶œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤"
              rollback_deployment
            fi

            # Node.js ë° Yarn í™•ì¸
            if ! command -v node &> /dev/null; then
              echo "âŒ Node.jsê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤"
              exit 1
            fi

            # Yarn ì„¤ì¹˜ í™•ì¸ ë° ì„¤ì •
            if ! command -v yarn &> /dev/null; then
              echo "ğŸ“¦ Yarn ì„¤ì¹˜ ì¤‘..."
              corepack enable || npm install -g corepack
              corepack prepare yarn@4.9.4 --activate
            fi

            echo "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘ (node_modules ìƒì„±)..."
            yarn install || {
              echo "âŒ yarn install ì‹¤íŒ¨"
              rollback_deployment
            }

            echo "âš™ï¸ í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„± ì¤‘..."
            cat > apps/backend/.env.staging << EOF
            # Environment
            NODE_ENV=staging

            # PORT
            PORT=8080

            # DOMAIN
            PUBLIC_USER_DOMAIN=${{ secrets.STAGING_PUBLIC_USER_DOMAIN }}
            PUBLIC_SELLER_DOMAIN=${{ secrets.STAGING_PUBLIC_SELLER_DOMAIN }}
            PUBLIC_ADMIN_DOMAIN=${{ secrets.STAGING_PUBLIC_ADMIN_DOMAIN }}

            # CORS Configuration
            CORS_ORIGIN=${{ secrets.STAGING_CORS_ORIGIN }}

            # JWT
            JWT_SECRET=${{ secrets.STAGING_JWT_SECRET }}

            # DATABASE
            # ì˜µì…˜ 1: EC2 PostgreSQL ì‚¬ìš© (ë¹„ìš© ì ˆê°)
            DATABASE_URL=postgresql://sweetorder_admin:${{ secrets.STAGING_DATABASE_PASSWORD }}@localhost:5432/sweetorder_staging_db?schema=public

            # GOOGLE OAuth
            GOOGLE_CLIENT_ID=${{ secrets.STAGING_GOOGLE_CLIENT_ID }}
            GOOGLE_CLIENT_SECRET=${{ secrets.STAGING_GOOGLE_CLIENT_SECRET }}
            GOOGLE_REDIRECT_URI=/auth/login/google

            # SWAGGER
            SWAGGER_USERNAME=${{ secrets.STAGING_SWAGGER_USERNAME }}
            SWAGGER_PASSWORD=${{ secrets.STAGING_SWAGGER_PASSWORD }}

            # NTS API
            NTS_API_URL=https://api.odcloud.kr/api
            KFTC_API_URL=https://apis.data.go.kr
            DATA_GO_KR_API_KEY=${{ secrets.STAGING_DATA_GO_KR_API_KEY }}

            # AWS S3
            AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
            AWS_REGION=ap-northeast-2
            S3_BUCKET=${{ secrets.STAGING_S3_BUCKET }}
            CLOUDFRONT_DOMAIN=${{ secrets.STAGING_CLOUDFRONT_DOMAIN }}
            EOF

            # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ê¶Œí•œ ì„¤ì •
            chmod 600 apps/backend/.env.staging

            echo "ğŸ—„ï¸ Prisma migrate ì‹¤í–‰"
            cd apps/backend
            DATABASE_URL=$(grep '^DATABASE_URL=' .env.staging | head -1 | cut -d '=' -f2- | tr -d '\r\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
            export DATABASE_URL

            if ! npx prisma migrate deploy --schema ./src/infra/database/prisma/schema.prisma; then
              echo "âŒ Prisma migrate ì‹¤íŒ¨"
              rollback_deployment
            fi

            cd ~/sweet-order/apps/backend

            echo "ğŸš€ PM2 restart"
            pm2 delete sweet-order-backend || true
            NODE_ENV=staging pm2 start dist/main.js \
              --name sweet-order-backend \
              --update-env \
              --cwd $(pwd) || {
              echo "âŒ PM2 ì‹œì‘ ì‹¤íŒ¨"
              rollback_deployment
            }
            pm2 save

            trap - ERR

            echo "âœ… ë°°í¬ ì™„ë£Œ!"
            pm2 list

            # ë°°í¬ ì„±ê³µ í›„ ë°±ì—… ì •ë¦¬ (1íšŒë§Œ ì‹¤í–‰)
            USE_PERCENT=$(get_disk_usage)
            cleanup_old_backups "ì„œë²„" "~/sweet-order.backup.*" "$USE_PERCENT"
            cleanup_old_backups "DB" "~/db-backup.*.dump" "$USE_PERCENT"
