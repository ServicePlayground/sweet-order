name: Deploy Backend to EC2 (Staging)

on:
  push:
    tags:
      - "backend/staging-*"

jobs:
  deploy-staging:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare source code package
        run: |
          # âš ï¸ ë¶ˆí•„ìš”í•œ íŒŒì¼ ì œì™¸í•˜ê³  ì••ì¶•
          mkdir -p /tmp/deploy
          tar -czf /tmp/deploy/deploy.tar.gz \
            --exclude=.git \
            --exclude=node_modules \
            --exclude=.yarn/cache \
            --exclude=.next \
            --exclude=dist \
            --exclude=apps/web-user \
            --exclude=apps/web-seller \
            --exclude=apps/web-admin \
            .
          mv /tmp/deploy/deploy.tar.gz .

      - name: Copy deployment package to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.STAGING_EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.STAGING_EC2_SSH_KEY }}
          source: "deploy.tar.gz"
          target: "~/"

      - name: Deploy to EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.STAGING_EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.STAGING_EC2_SSH_KEY }}
          script: |
            set -e

            echo "ðŸ“Š ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ ì²´í¬"
            USE_PERCENT=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
            if [ "$USE_PERCENT" -gt 80 ]; then
              echo "âŒ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ ${USE_PERCENT}% â€” ë°°í¬ ì¤‘ë‹¨"
              exit 1
            fi

            # ðŸ”¥ ì´ì „ ë°±ì—… ì œê±° (1ê°œë§Œ ìœ ì§€)
            rm -rf ~/sweet-order.backup.*

            # ê¸°ì¡´ í”„ë¡œì íŠ¸ ë°±ì—…
            if [ -d ~/sweet-order ]; then
              mv ~/sweet-order ~/sweet-order.backup
            fi

            mkdir -p ~/sweet-order
            cd ~/sweet-order

            echo "ðŸ“‚ ì••ì¶• í•´ì œ"
            tar -xzf ~/deploy.tar.gz
            rm ~/deploy.tar.gz

            # ìºì‹œ ì •ë¦¬ (ì¤‘ìš”)
            rm -rf ~/.cache ~/.yarn

            corepack enable
            corepack prepare yarn@4.9.4 --activate

            echo "ðŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜"
            yarn install --immutable

            echo "âš™ï¸ í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„± ì¤‘..."
            cat > apps/backend/.env.staging << EOF
            # Environment
            NODE_ENV=staging
            
            # PORT
            PORT=8080
            
            # DOMAIN
            PUBLIC_USER_DOMAIN=${{ secrets.STAGING_PUBLIC_USER_DOMAIN }}
            PUBLIC_SELLER_DOMAIN=${{ secrets.STAGING_PUBLIC_SELLER_DOMAIN }}
            PUBLIC_ADMIN_DOMAIN=${{ secrets.STAGING_PUBLIC_ADMIN_DOMAIN }}
            
            # CORS Configuration
            CORS_ORIGIN=${{ secrets.STAGING_CORS_ORIGIN }}
            
            # JWT
            JWT_SECRET=${{ secrets.STAGING_JWT_SECRET }}
            
            # DATABASE
            # ì˜µì…˜ 1: EC2 PostgreSQL ì‚¬ìš© (ë¹„ìš© ì ˆê°)
            DATABASE_URL=postgresql://sweetorder_admin:${{ secrets.STAGING_DATABASE_PASSWORD }}@localhost:5432/sweetorder_staging_db?schema=public
            
            # GOOGLE OAuth
            GOOGLE_CLIENT_ID=${{ secrets.STAGING_GOOGLE_CLIENT_ID }}
            GOOGLE_CLIENT_SECRET=${{ secrets.STAGING_GOOGLE_CLIENT_SECRET }}
            GOOGLE_REDIRECT_URI=/auth/login/google
            
            # SWAGGER
            SWAGGER_USERNAME=${{ secrets.STAGING_SWAGGER_USERNAME }}
            SWAGGER_PASSWORD=${{ secrets.STAGING_SWAGGER_PASSWORD }}
            
            # NTS API
            NTS_API_URL=https://api.odcloud.kr/api
            KFTC_API_URL=https://apis.data.go.kr
            DATA_GO_KR_API_KEY=${{ secrets.STAGING_DATA_GO_KR_API_KEY }}
            
            # AWS S3
            AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
            AWS_REGION=ap-northeast-2
            S3_BUCKET=${{ secrets.STAGING_S3_BUCKET }}
            CLOUDFRONT_DOMAIN=${{ secrets.STAGING_CLOUDFRONT_DOMAIN }}
            EOF
            
            # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ê¶Œí•œ ì„¤ì •
            chmod 600 apps/backend/.env.staging

            echo "ðŸ—„ï¸ Prisma migrate"
            cd apps/backend
            export DATABASE_URL=$(grep DATABASE_URL .env.staging | cut -d '=' -f2-)
            npx prisma migrate deploy --schema ./src/infra/database/prisma/schema.prisma
            cd ~/sweet-order

            echo "ðŸ”¨ Backend build"
            yarn run backend:build:staging

            echo "ðŸš€ PM2 restart"
            pm2 delete sweet-order-backend || true
            cd apps/backend
            NODE_ENV=staging pm2 start dist/main.js \
              --name sweet-order-backend \
              --update-env
            pm2 save
            pm2 status
