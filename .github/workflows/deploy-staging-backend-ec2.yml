name: Deploy Backend to EC2 (Staging)

on:
  push:
    tags:
      - "backend/staging-*"

jobs:
  deploy-staging:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare source code package
        run: |
          # ë¹Œë“œëŠ” EC2ì—ì„œ ìˆ˜í–‰
          # ì „ì²´ í”„ë¡œì íŠ¸ ì••ì¶•
          tar -czf deploy.tar.gz \
            --exclude='.git' \
            ./ || (echo "âš ï¸ tar ê²½ê³  ë°œìƒí–ˆì§€ë§Œ ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤" && exit 0)
            

      - name: Copy deployment package to EC2
        uses: appleboy/scp-action@master
        with:
          # EC2 í¼ë¸”ë¦­ IP ë˜ëŠ” ë„ë©”ì¸
          host: ${{ secrets.STAGING_EC2_HOST }}
          username: ec2-user
          # EC2 í‚¤ í˜ì–´ì˜ í”„ë¼ì´ë¹— í‚¤ ë‚´ìš©(ë¡œì»¬ì—ì„œ í•´ë‹¹ íŒŒì¼ ìœ„ì¹˜ì—ì„œ í„°ë¯¸ë„ cat sweet-order-backend-key.pem) (ì „ì²´ ë‚´ìš©, `-----BEGIN RSA PRIVATE KEY-----` ë¶€í„° `-----END RSA PRIVATE KEY-----` ê¹Œì§€)
          key: ${{ secrets.STAGING_EC2_SSH_KEY }}
          source: "deploy.tar.gz"
          target: "~/"

      - name: Deploy to EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.STAGING_EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.STAGING_EC2_SSH_KEY }}
          script: |
            # ê¸°ì¡´ í”„ë¡œì íŠ¸ ë°±ì—… (ì¡´ì¬í•˜ëŠ” ê²½ìš°)
            if [ -d ~/sweet-order ]; then
              BACKUP_DIR=~/sweet-order.backup.$(date +%Y%m%d_%H%M%S)
              echo "ğŸ“¦ ê¸°ì¡´ í”„ë¡œì íŠ¸ ë°±ì—… ì¤‘: $BACKUP_DIR"
              mv ~/sweet-order "$BACKUP_DIR" 2>/dev/null || true
            fi
            
            # ì‘ì—… ë””ë ‰í† ë¦¬ ìƒì„±
            mkdir -p ~/sweet-order
            cd ~/sweet-order
            
            # ë°°í¬ íŒ¨í‚¤ì§€ ì••ì¶• í•´ì œ
            echo "ğŸ“‚ ë°°í¬ íŒ¨í‚¤ì§€ ì••ì¶• í•´ì œ ì¤‘..."
            tar -xzf ~/deploy.tar.gz
            rm ~/deploy.tar.gz
            
            # Yarn Berry í™œì„±í™”
            corepack enable
            corepack prepare yarn@4.9.4 --activate
            
            # ì˜ì¡´ì„± ì„¤ì¹˜ (postinstall ìë™ ì‹¤í–‰ìœ¼ë¡œ Prisma Client ìƒì„±)
            yarn install
            
            # .env.staging íŒŒì¼ ìƒì„± (GitHub Secrets ì‚¬ìš©)
            echo "âš™ï¸ í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„± ì¤‘..."
            cat > apps/backend/.env.staging << EOF
            # Environment
            NODE_ENV=staging
            
            # PORT
            PORT=8080
            
            # DOMAIN
            PUBLIC_USER_DOMAIN=${{ secrets.STAGING_PUBLIC_USER_DOMAIN }}
            PUBLIC_SELLER_DOMAIN=${{ secrets.STAGING_PUBLIC_SELLER_DOMAIN }}
            PUBLIC_ADMIN_DOMAIN=${{ secrets.STAGING_PUBLIC_ADMIN_DOMAIN }}
            
            # CORS Configuration
            CORS_ORIGIN=${{ secrets.STAGING_CORS_ORIGIN }}
            
            # JWT
            JWT_SECRET=${{ secrets.STAGING_JWT_SECRET }}
            
            # DATABASE
            # ì˜µì…˜ 1: EC2 PostgreSQL ì‚¬ìš© (ë¹„ìš© ì ˆê°)
            DATABASE_URL=postgresql://sweetorder_admin:${{ secrets.STAGING_DATABASE_PASSWORD }}@localhost:5432/sweetorder_staging_db?schema=public
            
            # GOOGLE OAuth
            GOOGLE_CLIENT_ID=${{ secrets.STAGING_GOOGLE_CLIENT_ID }}
            GOOGLE_CLIENT_SECRET=${{ secrets.STAGING_GOOGLE_CLIENT_SECRET }}
            GOOGLE_REDIRECT_URI=/auth/login/google
            
            # SWAGGER
            SWAGGER_USERNAME=${{ secrets.STAGING_SWAGGER_USERNAME }}
            SWAGGER_PASSWORD=${{ secrets.STAGING_SWAGGER_PASSWORD }}
            
            # NTS API
            NTS_API_URL=https://api.odcloud.kr/api
            KFTC_API_URL=https://apis.data.go.kr
            DATA_GO_KR_API_KEY=${{ secrets.STAGING_DATA_GO_KR_API_KEY }}
            
            # AWS S3
            AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
            AWS_REGION=ap-northeast-2
            S3_BUCKET=${{ secrets.STAGING_S3_BUCKET }}
            CLOUDFRONT_DOMAIN=${{ secrets.STAGING_CLOUDFRONT_DOMAIN }}
            EOF
            
            # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ê¶Œí•œ ì„¤ì •
            chmod 600 apps/backend/.env.staging
            
            # Prisma ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
            echo "ğŸ—„ï¸ Prisma ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰ ì¤‘..."
            cd apps/backend
            # .env.staging íŒŒì¼ì—ì„œ DATABASE_URL ë¡œë“œ
            export DATABASE_URL=$(grep -v '^#' .env.staging | grep DATABASE_URL | cut -d '=' -f2- | tr -d ' ')
            if [ -z "$DATABASE_URL" ]; then
              echo "âŒ DATABASE_URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
              exit 1
            fi
            # ë§ˆì´ê·¸ë ˆì´ì…˜ ë°°í¬
            DATABASE_URL="$DATABASE_URL" npx prisma migrate deploy --schema ./src/infra/database/prisma/schema.prisma
            cd ~/sweet-order
            
            # ë°±ì—”ë“œ ë¹Œë“œ (EC2 í™˜ê²½ì—ì„œ ë¹Œë“œí•˜ì—¬ í”Œë«í¼ë³„ ë°”ì´ë„ˆë¦¬ ë¬¸ì œ í•´ê²°)
            echo "ğŸ”¨ ë°±ì—”ë“œ ë¹Œë“œ ì¤‘..."
            yarn run backend:build:staging
            
            # PM2ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¬ì‹œì‘
            # NestJS ConfigModuleì´ apps/backend/.env.staging íŒŒì¼ì„ ì½ìŒ
            echo "ğŸš€ PM2ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì¤‘..."
            pm2 delete sweet-order-backend 2>/dev/null || true
            cd ~/sweet-order/apps/backend
            NODE_ENV=staging pm2 start dist/main.js \
              --name sweet-order-backend \
              --cwd ~/sweet-order/apps/backend \
              --update-env
            cd ~/sweet-order
            
            # PM2 ìë™ ì‹œì‘ ì„¤ì • ì €ì¥
            pm2 save
            
            # ìƒíƒœ í™•ì¸
            echo "âœ… ë°°í¬ ì™„ë£Œ!"
            pm2 status
            pm2 list

            # ë¡œê·¸ í™•ì¸
            pm2 logs sweet-order-backend --lines 50
