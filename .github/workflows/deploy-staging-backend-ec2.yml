name: Deploy Backend to EC2 (Staging)

on:
  push:
    tags:
      - "backend/staging-*"

jobs:
  deploy-staging:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare source code package
        run: |
          # âš ï¸ ë¶ˆí•„ìš”í•œ íŒŒì¼ ì œì™¸í•˜ê³  ì••ì¶•
          mkdir -p /tmp/deploy
          tar -czf /tmp/deploy/deploy.tar.gz \
            --exclude=.git \
            --exclude=node_modules \
            --exclude=.yarn/cache \
            --exclude=.next \
            --exclude=dist \
            --exclude=apps/web-user \
            --exclude=apps/web-seller \
            --exclude=apps/web-admin \
            .
          mv /tmp/deploy/deploy.tar.gz .

      - name: Copy deployment package to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.STAGING_EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.STAGING_EC2_SSH_KEY }}
          source: "deploy.tar.gz"
          target: "~/"

      - name: Deploy to EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.STAGING_EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.STAGING_EC2_SSH_KEY }}
          script: |
            set -e

            echo "ðŸ“Š ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ ì²´í¬"
            USE_PERCENT=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
            echo "í˜„ìž¬ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰: ${USE_PERCENT}%"
            
            # ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ì´ 80% ì´ìƒì´ë©´ ì •ë¦¬ ìž‘ì—… ìˆ˜í–‰
            if [ "$USE_PERCENT" -gt 80 ]; then
              echo "âš ï¸ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ì´ ${USE_PERCENT}%ë¡œ ë†’ìŠµë‹ˆë‹¤. ì •ë¦¬ ìž‘ì—…ì„ ì‹œìž‘í•©ë‹ˆë‹¤..."
              
              # ì´ì „ ë°±ì—… ëª¨ë‘ ì œê±°
              echo "ðŸ—‘ï¸ ì´ì „ ë°±ì—… íŒŒì¼ ì œê±° ì¤‘..."
              rm -rf ~/sweet-order.backup.*
              
              # Yarn ìºì‹œ ì •ë¦¬
              echo "ðŸ—‘ï¸ Yarn ìºì‹œ ì •ë¦¬ ì¤‘..."
              yarn cache clean --all 2>/dev/null || true
              rm -rf ~/.cache ~/.yarn/cache
              
              # PM2 ë¡œê·¸ ì •ë¦¬ (ìµœê·¼ 100ì¤„ë§Œ ìœ ì§€)
              echo "ðŸ—‘ï¸ PM2 ë¡œê·¸ ì •ë¦¬ ì¤‘..."
              pm2 flush || true
              
              # ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ìºì‹œ ì •ë¦¬
              echo "ðŸ—‘ï¸ ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ìºì‹œ ì •ë¦¬ ì¤‘..."
              sudo dnf clean all 2>/dev/null || true
              
              # ìž„ì‹œ íŒŒì¼ ì •ë¦¬
              echo "ðŸ—‘ï¸ ìž„ì‹œ íŒŒì¼ ì •ë¦¬ ì¤‘..."
              sudo rm -rf /tmp/* 2>/dev/null || true
              rm -rf ~/tmp/* 2>/dev/null || true
              
              # ì •ë¦¬ í›„ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ ìž¬í™•ì¸
              USE_PERCENT=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
              echo "ì •ë¦¬ í›„ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰: ${USE_PERCENT}%"
              
              # ì—¬ì „ížˆ 95% ì´ìƒì´ë©´ ë°°í¬ ì¤‘ë‹¨
              if [ "$USE_PERCENT" -gt 95 ]; then
                echo "âŒ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ ${USE_PERCENT}% â€” ì •ë¦¬ í›„ì—ë„ ê³µê°„ ë¶€ì¡±. ë°°í¬ ì¤‘ë‹¨"
                exit 1
              fi
            fi

            # ðŸ”¥ ì´ì „ ë°±ì—… ì œê±° (íƒ€ìž„ìŠ¤íƒ¬í”„ê°€ ë¶™ì€ ë°±ì—…ë§Œ ì œê±°)
            rm -rf ~/sweet-order.backup.* 2>/dev/null || true
            # íƒ€ìž„ìŠ¤íƒ¬í”„ ì—†ëŠ” ê¸°ì¡´ ë°±ì—… ë””ë ‰í† ë¦¬ë„ ì œê±°
            rm -rf ~/sweet-order.backup 2>/dev/null || true

            # ê¸°ì¡´ í”„ë¡œì íŠ¸ ë°±ì—… (íƒ€ìž„ìŠ¤íƒ¬í”„ í¬í•¨)
            if [ -d ~/sweet-order ]; then
              BACKUP_NAME=~/sweet-order.backup.$(date +%Y%m%d_%H%M%S)
              echo "ðŸ“¦ ê¸°ì¡´ í”„ë¡œì íŠ¸ ë°±ì—… ì¤‘: $BACKUP_NAME"
              mv ~/sweet-order "$BACKUP_NAME" || {
                echo "âš ï¸ ë°±ì—… ì‹¤íŒ¨, ê¸°ì¡´ ë””ë ‰í† ë¦¬ ì‚­ì œ í›„ ì§„í–‰"
                rm -rf ~/sweet-order
              }
            fi

            mkdir -p ~/sweet-order
            cd ~/sweet-order

            echo "ðŸ“‚ ì••ì¶• í•´ì œ"
            tar -xzf ~/deploy.tar.gz
            rm ~/deploy.tar.gz

            # ìºì‹œ ì •ë¦¬ (ì¤‘ìš”)
            rm -rf ~/.cache ~/.yarn

            corepack enable
            corepack prepare yarn@4.9.4 --activate

            echo "ðŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜"
            yarn install

            echo "âš™ï¸ í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„± ì¤‘..."
            cat > apps/backend/.env.staging << EOF
            # Environment
            NODE_ENV=staging
            
            # PORT
            PORT=8080
            
            # DOMAIN
            PUBLIC_USER_DOMAIN=${{ secrets.STAGING_PUBLIC_USER_DOMAIN }}
            PUBLIC_SELLER_DOMAIN=${{ secrets.STAGING_PUBLIC_SELLER_DOMAIN }}
            PUBLIC_ADMIN_DOMAIN=${{ secrets.STAGING_PUBLIC_ADMIN_DOMAIN }}
            
            # CORS Configuration
            CORS_ORIGIN=${{ secrets.STAGING_CORS_ORIGIN }}
            
            # JWT
            JWT_SECRET=${{ secrets.STAGING_JWT_SECRET }}
            
            # DATABASE
            # ì˜µì…˜ 1: EC2 PostgreSQL ì‚¬ìš© (ë¹„ìš© ì ˆê°)
            DATABASE_URL=postgresql://sweetorder_admin:${{ secrets.STAGING_DATABASE_PASSWORD }}@localhost:5432/sweetorder_staging_db?schema=public
            
            # GOOGLE OAuth
            GOOGLE_CLIENT_ID=${{ secrets.STAGING_GOOGLE_CLIENT_ID }}
            GOOGLE_CLIENT_SECRET=${{ secrets.STAGING_GOOGLE_CLIENT_SECRET }}
            GOOGLE_REDIRECT_URI=/auth/login/google
            
            # SWAGGER
            SWAGGER_USERNAME=${{ secrets.STAGING_SWAGGER_USERNAME }}
            SWAGGER_PASSWORD=${{ secrets.STAGING_SWAGGER_PASSWORD }}
            
            # NTS API
            NTS_API_URL=https://api.odcloud.kr/api
            KFTC_API_URL=https://apis.data.go.kr
            DATA_GO_KR_API_KEY=${{ secrets.STAGING_DATA_GO_KR_API_KEY }}
            
            # AWS S3
            AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
            AWS_REGION=ap-northeast-2
            S3_BUCKET=${{ secrets.STAGING_S3_BUCKET }}
            CLOUDFRONT_DOMAIN=${{ secrets.STAGING_CLOUDFRONT_DOMAIN }}
            EOF
            
            # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ê¶Œí•œ ì„¤ì •
            chmod 600 apps/backend/.env.staging

            echo "ðŸ—„ï¸ Prisma migrate"
            cd apps/backend
            # DATABASE_URLì„ ì•ˆì „í•˜ê²Œ ì½ì–´ì„œ export (ì£¼ì„ ì œì™¸, ì²« ë²ˆì§¸ ë§¤ì¹­ë§Œ)
            DATABASE_URL=$(grep '^DATABASE_URL=' .env.staging | head -1 | cut -d '=' -f2- | tr -d '\r\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
            export DATABASE_URL
            echo "DATABASE_URL ì„¤ì • ì™„ë£Œ"
            
            # Prisma migrate ì‹¤í–‰
            if npx prisma migrate deploy --schema ./src/infra/database/prisma/schema.prisma; then
              echo "âœ… Prisma migrate ì„±ê³µ"
            else
              echo "âŒ Prisma migrate ì‹¤íŒ¨"
              echo ""
              echo "âš ï¸ PostgreSQL ì¸ì¦ ì„¤ì •ì´ í•„ìš”í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤."
              echo "ðŸ“– EC2 ì„œë²„ì— SSH ì ‘ì†í•˜ì—¬ ë‹¤ìŒì„ í™•ì¸í•˜ì„¸ìš”:"
              echo ""
              echo "1. pg_hba.conf íŒŒì¼ ìˆ˜ì •:"
              echo "   sudo vi /var/lib/pgsql/16/data/pg_hba.conf"
              echo "   'host all all 127.0.0.1/32 ident' â†’ 'host all all 127.0.0.1/32 md5'ë¡œ ë³€ê²½"
              echo ""
              echo "2. PostgreSQL ìž¬ì‹œìž‘:"
              echo "   sudo systemctl restart postgresql"
              echo ""
              echo "3. ìžì„¸í•œ ë‚´ìš©ì€ docs/infra/aws/EC2_Route53.md 3.3ë‹¨ê³„ë¥¼ ì°¸ê³ í•˜ì„¸ìš”."
              echo ""
              exit 1
            fi
            cd ~/sweet-order

            echo "ðŸ”¨ Backend build"
            yarn run backend:build:staging

            echo "ðŸš€ PM2 restart"
            pm2 delete sweet-order-backend || true
            cd apps/backend
            NODE_ENV=staging pm2 start dist/main.js \
              --name sweet-order-backend \
              --update-env \
              --cwd $(pwd)
            pm2 save
            echo "âœ… ë°°í¬ ì™„ë£Œ!"
            pm2 list
