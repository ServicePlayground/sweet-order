name: Deploy Backend to EC2 (Staging)

permissions:
  contents: read

on:
  push:
    tags:
      - "backend/staging-*"

jobs:
  deploy-staging:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare source code package
        run: |
          # âš ï¸ ë¶ˆí•„ìš”í•œ íŒŒì¼ ì œì™¸í•˜ê³  ì••ì¶•
          mkdir -p /tmp/deploy
          tar -czf /tmp/deploy/deploy.tar.gz \
            --exclude=.git \
            --exclude=node_modules \
            --exclude=.yarn/cache \
            --exclude=.next \
            --exclude=dist \
            --exclude=apps/web-user \
            --exclude=apps/web-seller \
            --exclude=apps/web-admin \
            .
          mv /tmp/deploy/deploy.tar.gz .

      - name: Copy deployment package to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.STAGING_EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.STAGING_EC2_SSH_KEY }}
          source: "deploy.tar.gz"
          target: "~/"

      - name: Deploy to EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.STAGING_EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.STAGING_EC2_SSH_KEY }}
          script: |
            set -e

            # ë¡¤ë°± í•¨ìˆ˜ ì •ì˜
            rollback_deployment() {
              echo ""
              echo "ğŸ”„ ë°°í¬ ì‹¤íŒ¨ë¡œ ì¸í•œ ë¡¤ë°± ì‹œì‘..."
              
              # PM2 í”„ë¡œì„¸ìŠ¤ ì¤‘ì§€ (ì´ë¯¸ ì‹¤íŒ¨í•œ ìƒˆ ë²„ì „ì´ ì‹¤í–‰ ì¤‘ì¼ ìˆ˜ ìˆìŒ)
              pm2 delete sweet-order-backend 2>/dev/null || true
              
              # ê°€ì¥ ìµœê·¼ ë°±ì—… ì°¾ê¸°
              LATEST_BACKUP=$(ls -td ~/sweet-order.backup.* 2>/dev/null | head -1)
              
              if [ -n "$LATEST_BACKUP" ] && [ -d "$LATEST_BACKUP" ]; then
                echo "ğŸ“¦ ë°±ì—… ë³µì› ì¤‘: $LATEST_BACKUP"
                rm -rf ~/sweet-order
                mv "$LATEST_BACKUP" ~/sweet-order
                
                # ì´ì „ ë²„ì „ìœ¼ë¡œ PM2 ì¬ì‹œì‘
                if [ -f ~/sweet-order/apps/backend/dist/main.js ]; then
                  cd ~/sweet-order/apps/backend
                  NODE_ENV=staging pm2 start dist/main.js \
                    --name sweet-order-backend \
                    --update-env \
                    --cwd $(pwd)
                  pm2 save
                  echo "âœ… ë¡¤ë°± ì™„ë£Œ - ì´ì „ ë²„ì „ìœ¼ë¡œ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤"
                else
                  echo "âš ï¸ ë¡¤ë°± ì‹¤íŒ¨ - ë°±ì—…ì— ë¹Œë“œ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤"
                fi
              else
                echo "âŒ ë¡¤ë°± ì‹¤íŒ¨ - ë°±ì—…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
              fi
              
              exit 1
            }

            # ë°±ì—… íŒŒì¼ ê°œìˆ˜ ì œí•œ í•¨ìˆ˜ (ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ì— ë”°ë¼ ë™ì  ì¡°ì •)
            cleanup_old_backups() {
              local BACKUP_TYPE=$1
              local BACKUP_PATTERN=$2
              local USE_PERCENT=$3
              local KEEP_COUNT=5
              
              # ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ì— ë”°ë¼ ë°±ì—… ê°œìˆ˜ ì¡°ì •
              if [ "$USE_PERCENT" -ge 90 ]; then
                KEEP_COUNT=2
                echo "âš ï¸ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ì´ ë†’ì•„ ë°±ì—…ì„ ìµœê·¼ ${KEEP_COUNT}ê°œë§Œ ìœ ì§€í•©ë‹ˆë‹¤"
              elif [ "$USE_PERCENT" -ge 85 ]; then
                KEEP_COUNT=3
                echo "âš ï¸ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ì´ ë†’ì•„ ë°±ì—…ì„ ìµœê·¼ ${KEEP_COUNT}ê°œë§Œ ìœ ì§€í•©ë‹ˆë‹¤"
              fi
              
              echo "ğŸ§¹ ì˜¤ë˜ëœ ${BACKUP_TYPE} ë°±ì—… ì •ë¦¬ ì¤‘ (ìµœê·¼ ${KEEP_COUNT}ê°œë§Œ ìœ ì§€)..."
              
              # íƒ€ì„ìŠ¤íƒ¬í”„ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬í•˜ì—¬ ì˜¤ë˜ëœ ê²ƒë¶€í„° ì‚­ì œ
              ls -t ${BACKUP_PATTERN} 2>/dev/null | tail -n +$((KEEP_COUNT + 1)) | while read -r old_backup; do
                echo "  ì‚­ì œ: $old_backup"
                rm -rf "$old_backup"
              done || true
            }

            echo "ğŸ“Š ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ ì²´í¬"
            USE_PERCENT=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
            echo "í˜„ì¬ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰: ${USE_PERCENT}%"

            # ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ì´ 80% ì´ìƒì´ë©´ ì •ë¦¬ ì‘ì—… ìˆ˜í–‰
            if [ "$USE_PERCENT" -gt 80 ]; then
              echo "âš ï¸ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ì´ ${USE_PERCENT}%ë¡œ ë†’ìŠµë‹ˆë‹¤. ì •ë¦¬ ì‘ì—…ì„ ì‹œì‘í•©ë‹ˆë‹¤..."
              
              # ì˜¤ë˜ëœ ë°±ì—… íŒŒì¼ ì •ë¦¬ (ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ì— ë”°ë¼ ë™ì  ì¡°ì •)
              echo "ğŸ—‘ï¸ ì˜¤ë˜ëœ ë°±ì—… íŒŒì¼ ì •ë¦¬ ì¤‘..."
              cleanup_old_backups "ì„œë²„" "~/sweet-order.backup.*" "$USE_PERCENT"
              cleanup_old_backups "DB" "~/db-backup.*.sql.gz" "$USE_PERCENT"
              
              # ê¸°ì¡´ í”„ë¡œì íŠ¸ì˜ node_modulesì™€ dist ì‚­ì œ (ë°±ì—… í¬ê¸° ì¤„ì´ê¸°)
              if [ -d ~/sweet-order ]; then
                echo "ğŸ—‘ï¸ ê¸°ì¡´ í”„ë¡œì íŠ¸ì˜ node_modules ë° dist ë””ë ‰í† ë¦¬ ì‚­ì œ ì¤‘..."
                find ~/sweet-order -type d -name "node_modules" -exec rm -rf {} + 2>/dev/null || true
                find ~/sweet-order -type d -name "dist" -exec rm -rf {} + 2>/dev/null || true
                find ~/sweet-order -type d -name ".next" -exec rm -rf {} + 2>/dev/null || true
                find ~/sweet-order -type d -name ".yarn" -exec rm -rf {} + 2>/dev/null || true
              fi
              
              # Yarn ìºì‹œ ì •ë¦¬
              echo "ğŸ—‘ï¸ Yarn ìºì‹œ ì •ë¦¬ ì¤‘..."
              yarn cache clean --all 2>/dev/null || true
              rm -rf ~/.cache ~/.yarn/cache ~/.yarn/berry/cache
              
              # PM2 ë¡œê·¸ ì •ë¦¬
              echo "ğŸ—‘ï¸ PM2 ë¡œê·¸ ì •ë¦¬ ì¤‘..."
              pm2 flush || true
              
              # ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ìºì‹œ ì •ë¦¬
              echo "ğŸ—‘ï¸ ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ìºì‹œ ì •ë¦¬ ì¤‘..."
              sudo dnf clean all 2>/dev/null || true
              
              # ì„ì‹œ íŒŒì¼ ì •ë¦¬
              echo "ğŸ—‘ï¸ ì„ì‹œ íŒŒì¼ ì •ë¦¬ ì¤‘..."
              sudo rm -rf /tmp/* 2>/dev/null || true
              rm -rf ~/tmp/* 2>/dev/null || true
              
              # ì •ë¦¬ í›„ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ ì¬í™•ì¸
              USE_PERCENT=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
              echo "ì •ë¦¬ í›„ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰: ${USE_PERCENT}%"
              
              # ì—¬ì „íˆ 95% ì´ìƒì´ë©´ ë°°í¬ ì¤‘ë‹¨
              if [ "$USE_PERCENT" -gt 95 ]; then
                echo "âŒ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ ${USE_PERCENT}% â€” ì •ë¦¬ í›„ì—ë„ ê³µê°„ ë¶€ì¡±. ë°°í¬ ì¤‘ë‹¨"
                exit 1
              fi
            fi

            # ì˜¤ë˜ëœ ë°±ì—… íŒŒì¼ ì •ë¦¬ (ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ì— ë”°ë¼ ë™ì  ì¡°ì •)
            cleanup_old_backups "ì„œë²„" "~/sweet-order.backup.*" "$USE_PERCENT"
            cleanup_old_backups "DB" "~/db-backup.*.sql.gz" "$USE_PERCENT"

            # ğŸ—„ï¸ DB ë°±ì—… ìƒì„± (ë°°í¬ ì „)
            echo "ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—… ìƒì„± ì¤‘..."
            DB_BACKUP_NAME=~/db-backup.$(date +%Y%m%d_%H%M%S).sql.gz
            PGPASSWORD='${{ secrets.STAGING_DATABASE_PASSWORD }}' \
              pg_dump -h localhost -p 5432 -U sweetorder_admin \
              -d sweetorder_staging_db \
              -F c -f "${DB_BACKUP_NAME%.gz}" 2>/dev/null || {
              echo "âš ï¸ DB ë°±ì—… ì‹¤íŒ¨ (ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤)"
              rm -f "${DB_BACKUP_NAME%.gz}"
            }

            # ì••ì¶• (ë°±ì—…ì´ ì„±ê³µí•œ ê²½ìš°ë§Œ)
            if [ -f "${DB_BACKUP_NAME%.gz}" ]; then
              gzip "${DB_BACKUP_NAME%.gz}"
              echo "âœ… DB ë°±ì—… ì™„ë£Œ: $DB_BACKUP_NAME"
            fi

            # ê¸°ì¡´ í”„ë¡œì íŠ¸ ë°±ì—… (íƒ€ì„ìŠ¤íƒ¬í”„ í¬í•¨)
            # ë°±ì—… ì „ì— node_modulesì™€ dist ì‚­ì œí•˜ì—¬ ë°±ì—… í¬ê¸° ìµœì†Œí™”
            CURRENT_BACKUP_NAME=""
            if [ -d ~/sweet-order ]; then
              echo "ğŸ—‘ï¸ ë°±ì—… ì „ ë¶ˆí•„ìš”í•œ íŒŒì¼ ì •ë¦¬ ì¤‘ (node_modules, dist ë“±)..."
              find ~/sweet-order -type d -name "node_modules" -exec rm -rf {} + 2>/dev/null || true
              find ~/sweet-order -type d -name "dist" -exec rm -rf {} + 2>/dev/null || true
              find ~/sweet-order -type d -name ".next" -exec rm -rf {} + 2>/dev/null || true
              find ~/sweet-order -type d -name ".yarn" -exec rm -rf {} + 2>/dev/null || true
              find ~/sweet-order -type f -name "*.log" -delete 2>/dev/null || true
              
              CURRENT_BACKUP_NAME=~/sweet-order.backup.$(date +%Y%m%d_%H%M%S)
              echo "ğŸ“¦ ê¸°ì¡´ í”„ë¡œì íŠ¸ ë°±ì—… ì¤‘: $CURRENT_BACKUP_NAME"
              mv ~/sweet-order "$CURRENT_BACKUP_NAME" || {
                echo "âš ï¸ ë°±ì—… ì‹¤íŒ¨, ê¸°ì¡´ ë””ë ‰í† ë¦¬ ì‚­ì œ í›„ ì§„í–‰"
                rm -rf ~/sweet-order
              }
            fi

            # ë°°í¬ ì‹¤íŒ¨ ì‹œ ë¡¤ë°±ì„ ìœ„í•œ trap ì„¤ì •
            trap rollback_deployment ERR

            mkdir -p ~/sweet-order
            cd ~/sweet-order

            echo "ğŸ“‚ ì••ì¶• í•´ì œ"
            tar -xzf ~/deploy.tar.gz
            rm ~/deploy.tar.gz

            # ê¸°ì¡´ node_modules ì •ë¦¬ (í˜¹ì‹œ ë‚¨ì•„ìˆì„ ìˆ˜ ìˆìŒ)
            echo "ğŸ—‘ï¸ ê¸°ì¡´ node_modules ì •ë¦¬ ì¤‘..."
            find ~/sweet-order -type d -name "node_modules" -exec rm -rf {} + 2>/dev/null || true

            # ìºì‹œ ì •ë¦¬ (ì¤‘ìš”)
            rm -rf ~/.cache ~/.yarn ~/.yarn/berry/cache

            corepack enable
            corepack prepare yarn@4.9.4 --activate

            # ë””ìŠ¤í¬ ê³µê°„ í™•ì¸ í›„ ì˜ì¡´ì„± ì„¤ì¹˜
            USE_PERCENT=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
            echo "ì˜ì¡´ì„± ì„¤ì¹˜ ì „ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰: ${USE_PERCENT}%"

            if [ "$USE_PERCENT" -gt 90 ]; then
              echo "âš ï¸ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ì´ ${USE_PERCENT}%ë¡œ ë†’ìŠµë‹ˆë‹¤. ì¶”ê°€ ì •ë¦¬ ì¤‘..."
              cleanup_old_backups "ì„œë²„" "~/sweet-order.backup.*" "$USE_PERCENT"
              cleanup_old_backups "DB" "~/db-backup.*.sql.gz" "$USE_PERCENT"
              USE_PERCENT=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
              echo "ì¶”ê°€ ì •ë¦¬ í›„ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰: ${USE_PERCENT}%"
            fi

            echo "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜"
            yarn install || {
              echo "âŒ ì˜ì¡´ì„± ì„¤ì¹˜ ì‹¤íŒ¨"
              rollback_deployment
            }

            echo "âš™ï¸ í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„± ì¤‘..."
            cat > apps/backend/.env.staging << EOF
            # Environment
            NODE_ENV=staging

            # PORT
            PORT=8080

            # DOMAIN
            PUBLIC_USER_DOMAIN=${{ secrets.STAGING_PUBLIC_USER_DOMAIN }}
            PUBLIC_SELLER_DOMAIN=${{ secrets.STAGING_PUBLIC_SELLER_DOMAIN }}
            PUBLIC_ADMIN_DOMAIN=${{ secrets.STAGING_PUBLIC_ADMIN_DOMAIN }}

            # CORS Configuration
            CORS_ORIGIN=${{ secrets.STAGING_CORS_ORIGIN }}

            # JWT
            JWT_SECRET=${{ secrets.STAGING_JWT_SECRET }}

            # DATABASE
            # ì˜µì…˜ 1: EC2 PostgreSQL ì‚¬ìš© (ë¹„ìš© ì ˆê°)
            DATABASE_URL=postgresql://sweetorder_admin:${{ secrets.STAGING_DATABASE_PASSWORD }}@localhost:5432/sweetorder_staging_db?schema=public

            # GOOGLE OAuth
            GOOGLE_CLIENT_ID=${{ secrets.STAGING_GOOGLE_CLIENT_ID }}
            GOOGLE_CLIENT_SECRET=${{ secrets.STAGING_GOOGLE_CLIENT_SECRET }}
            GOOGLE_REDIRECT_URI=/auth/login/google

            # SWAGGER
            SWAGGER_USERNAME=${{ secrets.STAGING_SWAGGER_USERNAME }}
            SWAGGER_PASSWORD=${{ secrets.STAGING_SWAGGER_PASSWORD }}

            # NTS API
            NTS_API_URL=https://api.odcloud.kr/api
            KFTC_API_URL=https://apis.data.go.kr
            DATA_GO_KR_API_KEY=${{ secrets.STAGING_DATA_GO_KR_API_KEY }}

            # AWS S3
            AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
            AWS_REGION=ap-northeast-2
            S3_BUCKET=${{ secrets.STAGING_S3_BUCKET }}
            CLOUDFRONT_DOMAIN=${{ secrets.STAGING_CLOUDFRONT_DOMAIN }}
            EOF

            # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ê¶Œí•œ ì„¤ì •
            chmod 600 apps/backend/.env.staging

            echo "ğŸ—„ï¸ Prisma migrate"
            cd apps/backend
            # DATABASE_URLì„ ì•ˆì „í•˜ê²Œ ì½ì–´ì„œ export (ì£¼ì„ ì œì™¸, ì²« ë²ˆì§¸ ë§¤ì¹­ë§Œ)
            DATABASE_URL=$(grep '^DATABASE_URL=' .env.staging | head -1 | cut -d '=' -f2- | tr -d '\r\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
            export DATABASE_URL
            echo "DATABASE_URL ì„¤ì • ì™„ë£Œ"

            # ì‹¤íŒ¨í•œ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‚¬ì „ í™•ì¸ ë° í•´ê²°
            echo "ğŸ” ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒíƒœ í™•ì¸ ì¤‘..."
            MIGRATE_STATUS=$(npx prisma migrate status --schema ./src/infra/database/prisma/schema.prisma 2>&1 || true)

            if echo "$MIGRATE_STATUS" | grep -q "failed\|P3009"; then
              echo "âš ï¸ ì‹¤íŒ¨í•œ ë§ˆì´ê·¸ë ˆì´ì…˜ ê°ì§€. ë¡¤ë°± ìƒíƒœë¡œ í‘œì‹œ ì¤‘..."
              # ì‹¤íŒ¨í•œ ë§ˆì´ê·¸ë ˆì´ì…˜ ì´ë¦„ ì¶”ì¶œ (ì¼ë°˜ì ìœ¼ë¡œ ê°€ì¥ ìµœê·¼ ì‹¤íŒ¨í•œ ê²ƒ)
              FAILED_MIGRATION=$(echo "$MIGRATE_STATUS" | grep -oP '^\s*\K[0-9_]+' | head -1 || echo "20260204214916_202602050649")
              
              if [ -n "$FAILED_MIGRATION" ]; then
                echo "ğŸ”§ ë§ˆì´ê·¸ë ˆì´ì…˜ '$FAILED_MIGRATION'ì„ ë¡¤ë°± ìƒíƒœë¡œ í‘œì‹œ ì¤‘..."
                npx prisma migrate resolve --rolled-back "$FAILED_MIGRATION" --schema ./src/infra/database/prisma/schema.prisma 2>/dev/null || true
                echo "âœ… ì‹¤íŒ¨í•œ ë§ˆì´ê·¸ë ˆì´ì…˜ í•´ê²° ì™„ë£Œ"
              fi
            fi

            # Prisma migrate ì‹¤í–‰
            MIGRATE_SUCCESS=false
            if ! npx prisma migrate deploy --schema ./src/infra/database/prisma/schema.prisma 2>&1 | tee /tmp/migrate_output.log; then
              MIGRATE_OUTPUT=$(cat /tmp/migrate_output.log)
              
              # P3009 ì˜¤ë¥˜: ì‹¤íŒ¨í•œ ë§ˆì´ê·¸ë ˆì´ì…˜ì´ ìˆëŠ” ê²½ìš°
              if echo "$MIGRATE_OUTPUT" | grep -q "P3009\|failed migrations"; then
                echo "âš ï¸ ì‹¤íŒ¨í•œ ë§ˆì´ê·¸ë ˆì´ì…˜ ê°ì§€. ë¡¤ë°± ìƒíƒœë¡œ í‘œì‹œ í›„ ì¬ì‹œë„..."
                
                # ì‹¤íŒ¨í•œ ë§ˆì´ê·¸ë ˆì´ì…˜ ì´ë¦„ ì¶”ì¶œ
                FAILED_MIGRATION=$(echo "$MIGRATE_OUTPUT" | grep -oP 'The `\K[^`]+' | head -1 || echo "20260204214916_202602050649")
                
                if [ -n "$FAILED_MIGRATION" ]; then
                  echo "ğŸ”§ ë§ˆì´ê·¸ë ˆì´ì…˜ '$FAILED_MIGRATION'ì„ ë¡¤ë°± ìƒíƒœë¡œ í‘œì‹œ ì¤‘..."
                  npx prisma migrate resolve --rolled-back "$FAILED_MIGRATION" --schema ./src/infra/database/prisma/schema.prisma 2>/dev/null || true
                  
                  echo "ğŸ”„ ë§ˆì´ê·¸ë ˆì´ì…˜ ì¬ì‹œë„ ì¤‘..."
                  if npx prisma migrate deploy --schema ./src/infra/database/prisma/schema.prisma; then
                    echo "âœ… Prisma migrate ì„±ê³µ (ì¬ì‹œë„ í›„)"
                    MIGRATE_SUCCESS=true
                  else
                    echo "âŒ Prisma migrate ì¬ì‹œë„ ì‹¤íŒ¨"
                    rollback_deployment
                  fi
                else
                  echo "âŒ ì‹¤íŒ¨í•œ ë§ˆì´ê·¸ë ˆì´ì…˜ ì´ë¦„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
                  rollback_deployment
                fi
              else
                echo "âŒ Prisma migrate ì‹¤íŒ¨"
                echo ""
                echo "âš ï¸ PostgreSQL ì¸ì¦ ì„¤ì •ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
                echo "ğŸ“– EC2 ì„œë²„ì— SSH ì ‘ì†í•˜ì—¬ ë‹¤ìŒì„ í™•ì¸í•˜ì„¸ìš”:"
                echo ""
                echo "1. pg_hba.conf íŒŒì¼ ìˆ˜ì •:"
                echo "   sudo vi /var/lib/pgsql/16/data/pg_hba.conf"
                echo "   'host all all 127.0.0.1/32 ident' â†’ 'host all all 127.0.0.1/32 md5'ë¡œ ë³€ê²½"
                echo ""
                echo "2. PostgreSQL ì¬ì‹œì‘:"
                echo "   sudo systemctl restart postgresql"
                echo ""
                echo "3. ìì„¸í•œ ë‚´ìš©ì€ docs/infra/aws/EC2_Route53.md 3.3ë‹¨ê³„ë¥¼ ì°¸ê³ í•˜ì„¸ìš”."
                echo ""
                rollback_deployment
              fi
            else
              echo "âœ… Prisma migrate ì„±ê³µ"
              MIGRATE_SUCCESS=true
            fi

            # Prisma Client ì¬ìƒì„± (ë§ˆì´ê·¸ë ˆì´ì…˜ ì„±ê³µ ì‹œì—ë§Œ)
            if [ "$MIGRATE_SUCCESS" = true ]; then
              echo "ğŸ”„ Prisma Client ì¬ìƒì„± ì¤‘..."
              npx prisma generate --schema ./src/infra/database/prisma/schema.prisma || {
                echo "âš ï¸ Prisma Client ì¬ìƒì„± ì‹¤íŒ¨ (ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤)"
              }
            fi

            cd ~/sweet-order

            echo "ğŸ”¨ Backend build"
            yarn run backend:build:staging || {
              echo "âŒ ë¹Œë“œ ì‹¤íŒ¨"
              rollback_deployment
            }

            echo "ğŸš€ PM2 restart"
            pm2 delete sweet-order-backend || true
            cd apps/backend
            NODE_ENV=staging pm2 start dist/main.js \
              --name sweet-order-backend \
              --update-env \
              --cwd $(pwd) || {
              echo "âŒ PM2 ì‹œì‘ ì‹¤íŒ¨"
              rollback_deployment
            }
            pm2 save

            # ë°°í¬ ì„±ê³µ ì‹œ trap í•´ì œ
            trap - ERR

            echo "âœ… ë°°í¬ ì™„ë£Œ!"
            pm2 list

            # ë°°í¬ ì„±ê³µ í›„ ì˜¤ë˜ëœ ë°±ì—… ì •ë¦¬ (ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ì— ë”°ë¼ ë™ì  ì¡°ì •)
            USE_PERCENT=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
            cleanup_old_backups "ì„œë²„" "~/sweet-order.backup.*" "$USE_PERCENT"
            cleanup_old_backups "DB" "~/db-backup.*.sql.gz" "$USE_PERCENT"
