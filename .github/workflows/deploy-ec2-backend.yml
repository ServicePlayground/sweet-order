name: Deploy Backend to AWS EC2

# GitHub Secrets ì„¤ì • ê°€ì´ë“œ
# í•„ìš”í•œ Secrets:
# 1. EC2_HOST: EC2 ì¸ìŠ¤í„´ìŠ¤ì˜ í¼ë¸”ë¦­ IP ë˜ëŠ” í¼ë¸”ë¦­ DNS
#    - í™•ì¸ ë°©ë²•: AWS ì½˜ì†” > EC2 > ì¸ìŠ¤í„´ìŠ¤ ì„ íƒ > "í¼ë¸”ë¦­ IPv4 ì£¼ì†Œ" ë˜ëŠ” "í¼ë¸”ë¦­ IPv4 DNS" ë³µì‚¬
#    - ì˜ˆì‹œ: ec2-xxx-xxx-xxx-xxx.ap-northeast-2.compute.amazonaws.com ë˜ëŠ” 1.2.3.4
#
# 2. EC2_SSH_KEY: EC2 í‚¤ í˜ì–´ì˜ .pem íŒŒì¼ ì „ì²´ ë‚´ìš©
#    - í™•ì¸ ë°©ë²•: EC2 ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì‹œ ë‹¤ìš´ë¡œë“œí•œ .pem íŒŒì¼ ë‚´ìš© ì „ì²´ ë³µì‚¬
#    - ì˜ˆì‹œ: sshí‚¤ê°€ ìˆëŠ” ë¡œì»¬ íŒŒì¼ ê²½ë¡œì—ì„œ `cat sweet-order-ec2-key-staging.pem` (ì „ì²´ ë‚´ìš©ì„ ë³µì‚¬)
#    - í˜•ì‹: -----BEGIN RSA PRIVATE KEY----- ... -----END RSA PRIVATE KEY-----
#
# 3. EC2_USER: (ì„ íƒì‚¬í•­) EC2 ì¸ìŠ¤í„´ìŠ¤ì˜ ì‚¬ìš©ìëª…, ê¸°ë³¸ê°’: 'ec2-user'
#    - Amazon Linux 2023ì˜ ê²½ìš°: ec2-user
#    - Ubuntuì˜ ê²½ìš°: ubuntu
#    - ì„¤ì •í•˜ì§€ ì•Šìœ¼ë©´ ê¸°ë³¸ê°’ 'ec2-user' ì‚¬ìš©

on:
  push:
    tags:
      - "backend/staging-*"

jobs:
  deploy-ec2:
    runs-on: ubuntu-latest

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. SSH ì„¤ì • (EC2 ì ‘ì†ì„ ìœ„í•œ í‚¤ íŒŒì¼ ë° known_hosts ì„¤ì •)
      - name: Setup SSH
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          mkdir -p ~/.ssh
          # EC2 SSH í‚¤ íŒŒì¼ ìƒì„±
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/ec2_key.pem
          chmod 600 ~/.ssh/ec2_key.pem
          # EC2 í˜¸ìŠ¤íŠ¸ë¥¼ known_hostsì— ì¶”ê°€ (SSH ì ‘ì† ì‹œ í˜¸ìŠ¤íŠ¸ í™•ì¸ ìŠ¤í‚µ)
          ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts

      # 3. ì½”ë“œë¥¼ EC2ë¡œ ì „ì†¡ (rsync ì‚¬ìš©)
      - name: Transfer code to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER || 'ec2-user' }}
        run: |
          # EC2ì— í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ìƒì„±
          ssh -i ~/.ssh/ec2_key.pem $EC2_USER@$EC2_HOST "mkdir -p ~/sweet-order"
          # ë¡œì»¬ ì½”ë“œë¥¼ EC2ë¡œ ë™ê¸°í™” (--delete: EC2ì— ìˆì§€ë§Œ ë¡œì»¬ì— ì—†ëŠ” íŒŒì¼ ì‚­ì œ)
          rsync -avz --delete -e "ssh -i ~/.ssh/ec2_key.pem" ./ $EC2_USER@$EC2_HOST:~/sweet-order/

      # 4. EC2ì—ì„œ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ì»¨í…Œì´ë„ˆ ë°°í¬
      - name: Build and deploy on EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER || 'ec2-user' }}
        run: |
          ssh -i ~/.ssh/ec2_key.pem $EC2_USER@$EC2_HOST << EOF
            set -e  # ì—ëŸ¬ ë°œìƒ ì‹œ ì¦‰ì‹œ ì¢…ë£Œ
            
            cd ~/sweet-order
            
            # ë³€ìˆ˜ ì„¤ì •
            CONTAINER_NAME="sweet-order-backend"
            IMAGE_NAME="sweet-order-backend:staging"
            AWS_REGION="ap-northeast-2"
            SECRET_NAME="sweetorder-ec2-env-staging"  # AWS Secrets Managerì˜ ë³´ì•ˆ ì•”í˜¸ ì´ë¦„
            
            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆê°€ ìˆìœ¼ë©´ ì¤‘ì§€ ë° ì œê±°
            if [ "\$(docker ps -aq -f name=\$CONTAINER_NAME)" ]; then
              docker stop \$CONTAINER_NAME || true
              docker rm \$CONTAINER_NAME || true
            fi
            
            # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” Docker ì´ë¯¸ì§€ ì •ë¦¬
            docker image prune -f
            
            # Docker ì´ë¯¸ì§€ ë¹Œë“œ
            echo "ğŸ”¨ Building Docker image..."
            docker build -f apps/infra/backend/Dockerfile -t \$IMAGE_NAME .
            
            # AWS Secrets Managerì—ì„œ í™˜ê²½ë³€ìˆ˜ JSON ê°€ì ¸ì˜¤ê¸°
            # EC2 ì¸ìŠ¤í„´ìŠ¤ì— IAM ì—­í• ì´ ì„¤ì •ë˜ì–´ ìˆì–´ì•¼ í•¨ (ec2-secrets-access-role-{í™˜ê²½})
            echo "ğŸ” Fetching secrets from AWS Secrets Manager..."
            SECRETS_JSON=\$(aws secretsmanager get-secret-value \
              --secret-id \$SECRET_NAME \
              --region \$AWS_REGION \
              --query SecretString \
              --output text)
            
            # Secrets ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ì²˜ë¦¬
            if [ -z "\$SECRETS_JSON" ]; then
              echo "âŒ Failed to fetch secrets from Secrets Manager"
              exit 1
            fi
            
            # Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰
            # -e SECRETS_ARN: í™˜ê²½ë³€ìˆ˜ë¡œ JSON ë¬¸ìì—´ ì „ë‹¬
            # ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ loadSecretsFromEnv() í•¨ìˆ˜ê°€ ì´ë¥¼ íŒŒì‹±í•˜ì—¬ process.envì— ì£¼ì…
            echo "ğŸš€ Starting container..."
            docker run -d \
              --name \$CONTAINER_NAME \
              --restart unless-stopped \
              -p 80:3000 \
              -e SECRETS_ARN="\$SECRETS_JSON" \
              \$IMAGE_NAME
            
            # ì»¨í…Œì´ë„ˆ ë¡œê·¸ í™•ì¸ (ë°°í¬ ìƒíƒœ ì ê²€)
            sleep 5
            docker logs --tail 50 \$CONTAINER_NAME
          EOF

